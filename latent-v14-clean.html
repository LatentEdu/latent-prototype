<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LATENT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg: #f5f5f7;
            --bg-card: #ffffff;
            --text: #1d1d1f;
            --text-secondary: rgba(29, 29, 31, 0.5);
            --text-tertiary: rgba(29, 29, 31, 0.35);
            --border: rgba(0, 0, 0, 0.06);
            --shadow: rgba(0, 0, 0, 0.08);
            --particle-color: 29, 29, 31;
            --btn-bg: #1d1d1f;
            --btn-text: #ffffff;
            --badge-bg: rgba(29, 29, 31, 0.05);
            --waveform: 29, 29, 31;
        }
        
        [data-theme="dark"] {
            --bg: #0a0a0a;
            --bg-card: #161616;
            --text: #f5f5f7;
            --text-secondary: rgba(245, 245, 247, 0.5);
            --text-tertiary: rgba(245, 245, 247, 0.35);
            --border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.4);
            --particle-color: 245, 245, 247;
            --btn-bg: #f5f5f7;
            --btn-text: #0a0a0a;
            --badge-bg: rgba(245, 245, 247, 0.08);
            --waveform: 245, 245, 247;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow: hidden;
            transition: background 0.4s ease, color 0.4s ease;
        }
        
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* Screens */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .screen.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Typing intro + auth CSS removed — handled by marketing page + wizard */
        
        
        
        /* Welcome Screen */
        .welcome-text {
            font-size: 48px;
            font-weight: 600;
            letter-spacing: -0.03em;
        }
        
        /* Tool Cards */
        .tools-container {
            display: grid;
            grid-template-columns: repeat(4, 240px);
            gap: 20px;
            justify-content: center;
            width: fit-content;
        }
        
        .tool-card {
            position: relative;
            height: 300px;
            background: var(--bg-card);
            border-radius: 24px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .tool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px var(--shadow);
        }
        
        .tool-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 32px 24px;
        }
        
        .tool-icon-wrapper {
            margin-top: 40px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tool-icon { width: 36px; height: 36px; }
        .tool-icon .icon-fill { fill: var(--text); }
        .tool-icon .icon-stroke { stroke: var(--text); }
        .tool-icon .icon-inner { stroke: var(--bg-card); }
        
        .tool-icon-text {
            font-size: 32px;
            color: var(--text);
        }
        
        .tool-title {
            margin-top: 20px;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        
        .tool-subtitle {
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            max-width: 160px;
            line-height: 1.4;
        }
        
        .coming-soon {
            position: absolute;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-tertiary);
            background: var(--badge-bg);
            padding: 4px 10px;
            border-radius: 100px;
        }
        
        /* ===================== */
        /* APP CONTAINERS        */
        /* ===================== */
        
        .app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .app-container.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .app-header {
            height: 56px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .back-btn:hover { background: var(--badge-bg); }
        .back-btn svg { width: 16px; height: 16px; }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-logo-text {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        
        .header-badge {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--badge-bg);
            padding: 3px 8px;
            border-radius: 100px;
        }
        
        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: 500;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .header-btn:hover {
            background: var(--badge-bg);
            color: var(--text);
        }
        
        .header-btn svg { width: 16px; height: 16px; }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--btn-bg);
            color: var(--btn-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Settings Dropdown */
        .settings-container {
            position: relative;
        }
        
        .settings-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 240px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 8px 32px var(--shadow);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
            z-index: 100;
            overflow: hidden;
        }
        
        .settings-dropdown.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .settings-dropdown-header {
            padding: 14px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            border-bottom: 1px solid var(--border);
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-size: 14px;
        }
        
        .settings-item:hover {
            background: var(--badge-bg);
        }
        
        .settings-item svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .settings-item span {
            flex: 1;
        }
        
        .settings-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }
        
        .settings-toggle {
            width: 40px;
            height: 22px;
            background: var(--badge-bg);
            border-radius: 11px;
            position: relative;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }
        
        .settings-toggle.active {
            background: var(--btn-bg);
        }
        
        .settings-toggle-knob {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .settings-toggle.active .settings-toggle-knob {
            transform: translateX(18px);
        }
        
        .app-main {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: clamp(16px, 3vw, 40px);
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            position: relative;
        }
        
        /* ===================== */
        /* ACADEMY               */
        /* ===================== */
        
        .onboard-container {
            width: 100%;
            max-width: 560px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 36px;
        }
        
        .onboard-header { text-align: center; }
        
        .onboard-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }
        
        .onboard-title {
            font-size: 38px;
            font-weight: 700;
            letter-spacing: -0.03em;
            line-height: 1.2;
            margin-bottom: 14px;
        }
        
        .onboard-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .input-card {
            width: 100%;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 28px;
        }
        
        .input-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .input-card-title { font-size: 15px; font-weight: 600; }
        .input-card-count { font-size: 13px; color: var(--text-tertiary); }
        
        .tags-area {
            min-height: 100px;
            background: var(--bg);
            border-radius: 12px;
            border: 2px dashed var(--border);
            padding: 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: flex-start;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }
        
        .tags-area.has-items { border-style: solid; }
        
        .tag {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 10px 14px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 500;
            animation: tagIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes tagIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .tag-remove {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: var(--badge-bg);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .tag-remove:hover {
            background: var(--text);
            color: var(--btn-text);
        }
        
        .tag-remove svg { width: 10px; height: 10px; }
        
        .input-row {
            display: flex;
            gap: 10px;
        }
        
        .input-sm {
            width: 80px;
            height: 48px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0 14px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            text-transform: uppercase;
            outline: none;
        }
        
        .input-md {
            width: 80px;
            height: 48px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0 14px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            outline: none;
        }
        
        .input-lg {
            flex: 1;
            height: 48px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0 14px;
            font-size: 15px;
            color: var(--text);
            outline: none;
        }
        
        .input-sm::placeholder, .input-md::placeholder, .input-lg::placeholder {
            color: var(--text-tertiary);
            text-transform: none;
            font-weight: 400;
        }
        
        .input-sm:focus, .input-md:focus, .input-lg:focus { border-color: var(--text-secondary); }
        
        .btn-add {
            height: 48px;
            padding: 0 18px;
            background: var(--btn-bg);
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--btn-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn-add:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .btn-add svg { width: 16px; height: 16px; }
        
        /* Syllabus Upload */
        .syllabus-upload {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg);
            margin-bottom: 16px;
        }
        
        .syllabus-upload:hover {
            border-color: var(--text-secondary);
            background: var(--badge-bg);
        }
        
        .syllabus-upload.dragover {
            border-color: var(--text);
            background: var(--badge-bg);
            transform: scale(1.01);
        }
        
        .syllabus-upload-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            background: var(--badge-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        .syllabus-upload-icon svg {
            width: 28px;
            height: 28px;
        }
        
        .syllabus-upload-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .syllabus-upload-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }
        
        .syllabus-upload-hint {
            font-size: 13px;
            color: var(--text-tertiary);
        }
        
        .syllabus-processing {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 24px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .syllabus-processing.hidden { display: none; }
        
        .syllabus-upload.hidden { display: none; }
        
        .processing-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--text);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .input-row-compact {
            margin-top: 8px;
        }
        
        .input-row-compact .btn-add {
            padding: 10px 14px;
        }

        .input-hint { font-size: 12px; color: var(--text-tertiary); margin-top: 10px; }
        
        .continue-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
        }
        
        .btn-continue {
            width: 100%;
            height: 54px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            opacity: 0.35;
            pointer-events: none;
        }
        
        .btn-continue.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .btn-continue.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }
        
        .btn-continue svg { width: 18px; height: 18px; }
        .continue-hint { font-size: 13px; color: var(--text-tertiary); }
        
        /* Dashboard */
        .dashboard { width: 100%; }
        .dashboard-header { margin-bottom: 40px; }
        .dashboard-greeting { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .dashboard-title { font-size: 36px; font-weight: 700; letter-spacing: -0.03em; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .course-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .course-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px var(--shadow);
        }
        
        .course-card-code {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        .course-card-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            line-height: 1.3;
        }
        
        .course-card-progress {
            height: 4px;
            background: var(--badge-bg);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .course-card-bar { height: 100%; background: var(--text); border-radius: 2px; }
        
        .course-card-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        .add-card {
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-height: 160px;
            transition: all 0.2s ease;
        }
        
        .add-card:hover {
            border-color: var(--text-secondary);
            background: var(--bg-card);
        }
        
        .add-card svg { width: 24px; height: 24px; color: var(--text-tertiary); }
        .add-card span { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        
        /* Academy Dashboard Layout */
        .academy-dashboard-layout {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 32px;
            min-height: 100%;
            padding-bottom: 24px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 8px;
        }
        
        .dashboard-header-left {}
        .dashboard-greeting { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .dashboard-title { font-size: 32px; font-weight: 700; letter-spacing: -0.03em; }
        
        .dashboard-header-right {
            display: flex;
            gap: 8px;
        }
        
        .btn-analytics {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn-analytics:hover {
            background: var(--badge-bg);
            border-color: var(--text-secondary);
        }
        
        .btn-analytics svg { width: 16px; height: 16px; }
        
        .dashboard-top {
            display: flex;
            gap: 20px;
        }
        
        .dashboard-main {
            flex: 1;
        }
        
        /* Needs Attention - Now on right */
        .needs-attention-sidebar {
            width: clamp(220px, 20vw, 320px);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .attention-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            border-left: 3px solid #f59e0b;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .attention-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .attention-card.critical { border-left-color: #ef4444; }
        
        .attention-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .attention-card-code {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .attention-card-percent {
            font-size: 12px;
            font-weight: 600;
            color: #f59e0b;
        }
        
        .attention-card.critical .attention-card-percent { color: #ef4444; }
        
        .attention-card-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .attention-card-reason {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        .attention-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }
        
        .attention-section-title svg { width: 14px; height: 14px; color: #f59e0b; }
        
        /* Today Bar - Full width at bottom - Always expanded */
        .today-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin-top: auto;
        }
        
        .today-bar-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        
        .today-bar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .today-date {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border-radius: 10px;
            min-width: 50px;
        }
        
        .today-date-day { font-size: 20px; font-weight: 700; line-height: 1; }
        .today-date-month { font-size: 10px; font-weight: 600; text-transform: uppercase; margin-top: 2px; }
        
        .today-info {}
        .today-label { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .today-summary { font-size: 12px; color: var(--text-secondary); }
        
        .today-tasks-preview {
            display: flex;
            gap: 12px;
        }
        
        .today-task-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg);
            border-radius: 100px;
            font-size: 12px;
        }
        
        .today-task-chip .task-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        /* Always expanded content */
        .today-expanded {
            padding: 20px;
        }
        
        .today-expanded-content {
            display: flex;
            gap: 24px;
            align-items: start;
            overflow: hidden;
        }
        
        .calendar-mini {
            width: 260px;
            min-width: 260px;
            max-width: 260px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .calendar-mini-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .calendar-mini-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .calendar-mini-nav {
            display: flex;
            gap: 4px;
        }
        
        .calendar-mini-nav button {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border);
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        .calendar-mini-nav button:hover { background: var(--badge-bg); }
        .calendar-mini-nav button svg { width: 14px; height: 14px; }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            padding: 4px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .calendar-day {
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .calendar-day:hover { background: var(--badge-bg); }
        .calendar-day.other-month { color: var(--text-tertiary); }
        .calendar-day.today { background: var(--btn-bg); color: var(--btn-text); font-weight: 600; }
        
        /* Apple Calendar-style heat map — busier = darker fill */
        .calendar-day.busy-1 { background: rgba(59, 130, 246, 0.10); }
        .calendar-day.busy-2 { background: rgba(59, 130, 246, 0.22); }
        .calendar-day.busy-3 { background: rgba(59, 130, 246, 0.38); color: #fff; font-weight: 500; }
        .calendar-day.today { background: var(--btn-bg); color: var(--btn-text); font-weight: 600; }
        
        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 4px;
            height: 4px;
            background: var(--text);
            border-radius: 50%;
        }
        
        .calendar-day.today.has-event::after { background: var(--btn-text); }
        .calendar-day.busy-3.has-event::after { background: #fff; }
        
        /* Tasks List */
        .tasks-list {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            width: 100%;
        }
        
        .tasks-list-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 10px;
            margin-bottom: 8px;
            width: 100%;
        }
        
        .task-item:last-child { margin-bottom: 0; }
        
        .task-dot-lg {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-top: 4px;
            flex-shrink: 0;
        }
        
        .task-time {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 60px;
        }
        
        .task-details { flex: 1; }
        .task-title { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
        .task-course { font-size: 11px; color: var(--text-tertiary); }
        
        /* ===================== */
        /* ANALYTICS VIEW        */
        /* ===================== */
        
        .analytics-view {
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            background: var(--bg);
            display: none;
            flex-direction: column;
            gap: 24px;
            overflow: auto;
            padding: clamp(16px, 3vw, 40px);
            padding-bottom: 20px;
        }
        
        .analytics-view.visible { display: flex; }
        
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .analytics-back {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .analytics-title { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; }
        
        .analytics-period {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .period-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .period-btn:hover { color: var(--text); }
        .period-btn.active { background: var(--btn-bg); color: var(--btn-text); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-label svg { width: 14px; height: 14px; }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }
        
        .stat-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stat-change.positive { color: #22c55e; }
        .stat-change.negative { color: #ef4444; }
        .stat-change svg { width: 12px; height: 12px; }
        
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
        }
        
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title { font-size: 14px; font-weight: 600; }
        
        .chart-legend {
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .trend-chart {
            height: 180px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding-top: 20px;
        }
        
        .trend-bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .trend-bars {
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 140px;
        }
        
        .trend-bar {
            width: 16px;
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease;
        }
        
        .trend-bar.score { background: var(--btn-bg); }
        .trend-bar.retention { background: var(--text-tertiary); }
        
        .trend-label {
            font-size: 10px;
            color: var(--text-tertiary);
        }
        
        .retention-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .retention-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .retention-name {
            flex: 1;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .retention-bar-bg {
            width: 80px;
            height: 6px;
            background: var(--badge-bg);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .retention-bar {
            height: 100%;
            border-radius: 3px;
        }
        
        .retention-bar.high { background: #22c55e; }
        .retention-bar.medium { background: #f59e0b; }
        .retention-bar.low { background: #ef4444; }
        
        .retention-percent {
            font-size: 12px;
            font-weight: 600;
            min-width: 36px;
            text-align: right;
        }
        
        .struggling-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
        }
        
        .struggling-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .struggling-header svg { width: 16px; height: 16px; color: #ef4444; }
        .struggling-title { font-size: 14px; font-weight: 600; }
        
        .struggling-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .struggling-item {
            padding: 14px;
            background: var(--bg);
            border-radius: 12px;
            border-left: 3px solid #ef4444;
        }
        
        .struggling-item-course {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }
        
        .struggling-item-topic {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .struggling-item-stat {
            font-size: 11px;
            color: #ef4444;
        }
        
        /* Studio styles below */
        
        /* ===================== */
        /* ANALYTICS             */
        /* ===================== */
        
        .analytics-view {
            width: 100%;
            
            display: none;
            flex-direction: column;
            gap: 24px;
            overflow: auto;
            padding-bottom: 20px;
        }
        
        .analytics-view.visible { display: flex; }
        
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .analytics-header-left {}
        .analytics-back {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 8px;
        }
        .analytics-back:hover { color: var(--text); }
        .analytics-back svg { width: 16px; height: 16px; }
        .analytics-title { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; }
        
        .analytics-period {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .period-btn {
            padding: 8px 14px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .period-btn.active {
            background: var(--btn-bg);
            color: var(--btn-text);
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }
        
        .stat-trend {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stat-trend.up { color: #22c55e; }
        .stat-trend.down { color: #ef4444; }
        .stat-trend svg { width: 14px; height: 14px; }
        
        .analytics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .analytics-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            min-width: 0;
            overflow: hidden;
        }
        
        .analytics-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .analytics-card-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .analytics-card-action {
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .analytics-card-action:hover { color: var(--text); }
        
        /* Chart placeholder */
        .chart-area {
            height: 180px;
            background: var(--bg);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .line-chart {
            width: 100%;
            height: 100%;
            padding: 20px;
            position: relative;
        }
        
        .chart-svg {
            width: 100%;
            height: 100%;
        }
        
        .chart-line {
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .chart-line.user {
            stroke: var(--text);
        }
        
        .chart-line.class-avg {
            stroke: var(--text-tertiary);
            stroke-dasharray: 4 4;
        }
        
        .chart-dot {
            fill: var(--btn-bg);
            stroke: var(--bg-card);
            stroke-width: 2;
        }
        
        .chart-dot.class-dot {
            fill: var(--text-tertiary);
        }
        
        .chart-area-fill {
            fill: url(#chartGradient);
            opacity: 0.15;
        }
        
        .chart-legend {
            position: absolute;
            bottom: 12px;
            right: 16px;
            display: flex;
            gap: 16px;
            font-size: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }
        
        .legend-line {
            width: 16px;
            height: 2px;
            border-radius: 1px;
        }
        
        .legend-line.solid { background: var(--text); }
        .legend-line.dashed { 
            background: repeating-linear-gradient(90deg, var(--text-tertiary) 0, var(--text-tertiary) 4px, transparent 4px, transparent 8px);
        }
        
        .chart-labels {
            position: absolute;
            bottom: 8px;
            left: 20px;
            right: 60px;
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--text-tertiary);
        }
        
        .your-position {
            position: absolute;
            top: 12px;
            left: 16px;
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .position-dot {
            width: 8px;
            height: 8px;
            background: var(--btn-bg);
            border-radius: 50%;
        }
        
        /* Animate line drawing */
        @keyframes drawLine {
            from { stroke-dashoffset: 1000; }
            to { stroke-dashoffset: 0; }
        }
        
        .chart-line.animate {
            stroke-dasharray: 1000;
            animation: drawLine 1.5s ease-out forwards;
        }
        
        @keyframes fadeInDot {
            from { opacity: 0; transform: scale(0); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .chart-dot.animate {
            animation: fadeInDot 0.3s ease-out forwards;
            animation-delay: 1.2s;
            opacity: 0;
        }
        
        /* Topics list */
        .topics-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .topic-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 10px;
        }
        
        .topic-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .topic-status.mastered { background: #22c55e; }
        .topic-status.learning { background: #f59e0b; }
        .topic-status.struggling { background: #ef4444; }
        
        .topic-info { flex: 1; min-width: 0; }
        .topic-name { font-size: 13px; font-weight: 500; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .topic-course { font-size: 11px; color: var(--text-tertiary); }
        .topic-percent { font-size: 13px; font-weight: 600; flex-shrink: 0; }
        
        /* Retention chart */
        .retention-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: clamp(3px, 1vw, 6px);
        }
        
        .retention-day {
            aspect-ratio: 1;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(8px, 1.5vw, 10px);
            font-weight: 500;
            min-width: 0;
            overflow: hidden;
        }
        
        .retention-day.level-0 { background: var(--bg); color: var(--text-tertiary); }
        .retention-day.level-1 { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .retention-day.level-2 { background: rgba(34, 197, 94, 0.4); color: #22c55e; }
        .retention-day.level-3 { background: rgba(34, 197, 94, 0.6); color: #fff; }
        .retention-day.level-4 { background: #22c55e; color: #fff; }
        
        /* ===================== */
        /* COURSE DETAIL         */
        /* ===================== */
        
        .course-detail-view {
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            background: var(--bg);
            display: none;
            flex-direction: column;
            gap: 24px;
            overflow: auto;
            padding: clamp(16px, 3vw, 40px);
            padding-bottom: 20px;
        }
        
        .course-detail-view.visible { display: flex; }
        
        .course-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .course-detail-left {
            flex: 1;
        }
        
        .course-detail-back {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .course-detail-back:hover { color: var(--text); }
        .course-detail-back svg { width: 16px; height: 16px; }
        
        .course-detail-name {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .course-detail-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .btn-sync {
            padding: 12px 20px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn-sync:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .btn-sync svg { width: 18px; height: 18px; }
        
        .btn-rewind {
            padding: 12px 20px;
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .btn-rewind:hover { 
            background: var(--badge-bg); 
            border-color: var(--text-secondary);
        }
        .btn-rewind svg { width: 18px; height: 18px; }
        
        /* ============ REWIND VIEW ============ */
        .rewind-view {
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 15;
            background: var(--bg);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .rewind-view.visible { display: flex; }
        
        .rewind-header {
            padding: 16px clamp(16px, 3vw, 40px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .rewind-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .rewind-back {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.2s;
        }
        
        .rewind-back:hover { background: var(--badge-bg); }
        .rewind-back svg { width: 18px; height: 18px; }
        
        .rewind-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .rewind-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 1px;
        }
        
        .rewind-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .rewind-mode-toggle {
            display: flex;
            align-items: center;
            background: var(--badge-bg);
            border-radius: 10px;
            padding: 3px;
        }
        
        .rewind-mode-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .rewind-mode-btn.active {
            background: var(--bg-card);
            color: var(--text);
            box-shadow: 0 1px 4px var(--shadow);
        }
        
        .rewind-progress-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .rewind-progress-track {
            width: 100px;
            height: 4px;
            background: var(--badge-bg);
            border-radius: 100px;
            overflow: hidden;
        }
        
        .rewind-progress-fill {
            height: 100%;
            background: var(--text);
            border-radius: 100px;
            transition: width 0.4s ease;
        }
        
        /* Split layout */
        .rewind-split {
            flex: 1;
            display: flex;
            min-height: 0;
        }
        
        /* Left panel — concepts */
        .rewind-panel-left {
            width: 300px;
            min-width: 300px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .rewind-panel-label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }
        
        .rewind-concept-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .rewind-concept-item:hover {
            background: var(--badge-bg);
        }
        
        .rewind-concept-item.active {
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .rewind-concept-item.completed {
            opacity: 0.45;
        }
        
        .rewind-concept-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .rewind-concept-dot.urgent { background: #ff5f57; }
        .rewind-concept-dot.due { background: #ffbd2e; }
        .rewind-concept-dot.fresh { background: #28c840; }
        
        .rewind-concept-info {
            flex: 1;
            min-width: 0;
        }
        
        .rewind-concept-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .rewind-concept-meta {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        
        .rewind-concept-score {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        /* Right panel — flashcard quiz */
        .rewind-panel-right {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 32px;
            gap: 24px;
            min-width: 0;
        }
        
        .rewind-card-counter {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }
        
        /* Flashcard */
        .flashcard {
            width: 100%;
            max-width: 520px;
            min-height: 240px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 44px 36px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .flashcard:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px var(--shadow);
        }
        
        .flashcard-label {
            position: absolute;
            top: 18px;
            left: 24px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }
        
        .flashcard-concept {
            position: absolute;
            top: 18px;
            right: 24px;
            font-size: 10px;
            color: var(--text-tertiary);
            background: var(--badge-bg);
            padding: 3px 10px;
            border-radius: 100px;
        }
        
        .flashcard-content {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.55;
            letter-spacing: -0.01em;
            max-width: 460px;
        }
        
        .flashcard-hint {
            margin-top: 16px;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        .flashcard.flipped .flashcard-content {
            font-size: 15px;
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.7;
        }
        
        /* Options grid */
        .flashcard-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 520px;
        }
        
        .flashcard-options.hidden { display: none; }
        
        .option-btn {
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 13px;
            font-weight: 400;
            font-family: inherit;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            line-height: 1.5;
        }
        
        .option-btn:hover {
            border-color: var(--text-secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .option-btn.correct {
            border-color: #28c840;
            background: rgba(40, 200, 64, 0.08);
            color: #28c840;
            font-weight: 500;
        }
        
        .option-btn.wrong {
            border-color: #ff5f57;
            background: rgba(255, 95, 87, 0.05);
            opacity: 0.6;
        }
        
        .option-btn.disabled { pointer-events: none; }
        
        .option-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            margin-bottom: 3px;
            letter-spacing: 0.02em;
        }
        
        /* Shake & flash */
        @keyframes cardShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80% { transform: translateX(6px); }
        }
        
        @keyframes cardFlashRed {
            0% { box-shadow: 0 0 0 0 rgba(255, 95, 87, 0); }
            30% { box-shadow: 0 0 40px 8px rgba(255, 95, 87, 0.25); }
            100% { box-shadow: 0 0 0 0 rgba(255, 95, 87, 0); }
        }
        
        @keyframes cardFlashGreen {
            0% { box-shadow: 0 0 0 0 rgba(40, 200, 64, 0); }
            30% { box-shadow: 0 0 40px 8px rgba(40, 200, 64, 0.25); }
            100% { box-shadow: 0 0 0 0 rgba(40, 200, 64, 0); }
        }
        
        .flashcard.shake { animation: cardShake 0.5s ease, cardFlashRed 0.8s ease; }
        .flashcard.correct-flash { animation: cardFlashGreen 0.8s ease; }
        
        .see-answer-link {
            font-size: 13px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: color 0.2s;
            text-align: center;
            padding: 4px;
        }
        
        .see-answer-link:hover { color: var(--text); }
        .see-answer-link.hidden { display: none; }
        
        /* Free recall actions */
        .rewind-actions {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 520px;
        }
        
        .rewind-btn {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
            cursor: pointer;
            font-family: inherit;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .rewind-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .rewind-btn-label { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
        .rewind-btn-sub { font-size: 10px; color: var(--text-tertiary); }
        
        .rewind-btn.again .rewind-btn-label { color: #ff5f57; }
        .rewind-btn.hard .rewind-btn-label { color: #ffbd2e; }
        .rewind-btn.good .rewind-btn-label { color: #28c840; }
        .rewind-btn.easy .rewind-btn-label { color: var(--accent); }
        
        .rewind-btn.again:hover { border-color: #ff5f57; background: rgba(255, 95, 87, 0.05); }
        .rewind-btn.hard:hover { border-color: #ffbd2e; background: rgba(255, 189, 46, 0.05); }
        .rewind-btn.good:hover { border-color: #28c840; background: rgba(40, 200, 64, 0.05); }
        .rewind-btn.easy:hover { border-color: var(--accent); background: var(--accent-soft); }
        
        .rewind-actions.hidden { opacity: 0; pointer-events: none; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .rewind-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 12px 16px;
            }
            
            .rewind-header-right {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .rewind-split {
                flex-direction: column;
            }
            
            .rewind-panel-left {
                width: 100%;
                min-width: unset;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 160px;
                padding: 12px;
                flex-direction: row;
                flex-wrap: nowrap;
                overflow-x: auto;
                overflow-y: hidden;
                gap: 8px;
            }
            
            .rewind-panel-label {
                display: none;
            }
            
            .rewind-concept-item {
                min-width: 180px;
                flex-shrink: 0;
                padding: 10px 12px;
            }
            
            .rewind-panel-right {
                padding: 24px 16px;
            }
            
            .flashcard {
                padding: 36px 24px;
                min-height: 200px;
            }
            
            .flashcard-content { font-size: 16px; }
            
            .flashcard-options { grid-template-columns: 1fr; }
            
            .rewind-actions { flex-wrap: wrap; }
            .rewind-btn { min-width: calc(50% - 5px); }
        }
        
        @media (max-width: 420px) {
            .flashcard-content { font-size: 14px; }
            .rewind-btn { padding: 10px 12px; }
            .option-btn { padding: 12px; font-size: 12px; }
        }
        
        /* ============ DEEP DIVE VIEW ============ */
        .deepdive-view {
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 20;
            background: var(--bg);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .deepdive-view.visible { display: flex; }
        
        .deepdive-header {
            padding: 16px clamp(16px, 3vw, 32px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .deepdive-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .deepdive-back {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.2s;
        }
        
        .deepdive-back:hover { background: var(--badge-bg); }
        .deepdive-back svg { width: 18px; height: 18px; }
        
        .deepdive-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .deepdive-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 1px;
        }
        
        /* Live Latency Score */
        .deepdive-score-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .deepdive-score {
            position: relative;
            width: 56px;
            height: 56px;
        }
        
        .deepdive-score-ring {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .deepdive-score-ring-bg {
            fill: none;
            stroke: var(--badge-bg);
            stroke-width: 4;
        }
        
        .deepdive-score-ring-fill {
            fill: none;
            stroke: var(--text);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.6s ease, stroke 0.3s ease;
        }
        
        .deepdive-score-ring-fill.rising {
            stroke: #28c840;
        }
        
        .deepdive-score-ring-fill.falling {
            stroke: #ff5f57;
        }
        
        .deepdive-score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            font-weight: 700;
            font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
        }
        
        .deepdive-score-label {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        @keyframes scorePulseUp {
            0% { box-shadow: 0 0 0 0 rgba(40, 200, 64, 0.4); }
            70% { box-shadow: 0 0 0 12px rgba(40, 200, 64, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 200, 64, 0); }
        }
        
        @keyframes scorePulseDown {
            0% { box-shadow: 0 0 0 0 rgba(255, 95, 87, 0.4); }
            70% { box-shadow: 0 0 0 12px rgba(255, 95, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 95, 87, 0); }
        }
        
        .deepdive-score.pulse-up {
            animation: scorePulseUp 0.6s ease;
            border-radius: 50%;
        }
        
        .deepdive-score.pulse-down {
            animation: scorePulseDown 0.6s ease;
            border-radius: 50%;
        }
        
        /* Split layout */
        .deepdive-split {
            flex: 1;
            display: flex;
            min-height: 0;
        }
        
        /* Left panel — context */
        .deepdive-panel-left {
            width: 320px;
            min-width: 320px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .deepdive-context-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .deepdive-context-label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }
        
        .deepdive-concept-name {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }
        
        .deepdive-professor-note {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .deepdive-professor-note::before {
            content: '"';
            font-size: 24px;
            color: var(--text-tertiary);
            line-height: 0;
            vertical-align: -8px;
            margin-right: 4px;
        }
        
        .deepdive-related {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .deepdive-related-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--badge-bg);
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .deepdive-related-item:hover {
            background: var(--bg-card);
            transform: translateX(4px);
        }
        
        .deepdive-related-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-tertiary);
        }
        
        .deepdive-source-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .deepdive-source-btn:hover {
            border-color: var(--text-secondary);
        }
        
        .deepdive-source-btn svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }
        
        /* Right panel — conversation */
        .deepdive-panel-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg);
        }
        
        .deepdive-conversation {
            flex: 1;
            overflow-y: auto;
            padding: 24px clamp(20px, 4vw, 48px);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .deepdive-message {
            max-width: 85%;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .deepdive-message.ai {
            align-self: flex-start;
        }
        
        .deepdive-message.user {
            align-self: flex-end;
        }
        
        .deepdive-message-tag {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            width: fit-content;
        }
        
        .deepdive-message-tag.probe {
            background: rgba(88, 86, 214, 0.12);
            color: #5856d6;
        }
        
        .deepdive-message-tag.challenge {
            background: rgba(255, 149, 0, 0.12);
            color: #ff9500;
        }
        
        .deepdive-message-tag.connect {
            background: rgba(0, 122, 255, 0.12);
            color: #007aff;
        }
        
        .deepdive-message-tag.confirm {
            background: rgba(40, 200, 64, 0.12);
            color: #28c840;
        }
        
        .deepdive-message-tag.nudge {
            background: rgba(255, 149, 0, 0.12);
            color: #ff9500;
        }
        
        .deepdive-message-bubble {
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.55;
        }
        
        .deepdive-message.ai .deepdive-message-bubble {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 6px;
        }
        
        .deepdive-message.user .deepdive-message-bubble {
            background: var(--btn-bg);
            color: var(--btn-text);
            border-bottom-right-radius: 6px;
        }
        
        .deepdive-score-change {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            width: fit-content;
            margin-top: 4px;
        }
        
        .deepdive-score-change.positive {
            background: rgba(40, 200, 64, 0.12);
            color: #28c840;
        }
        
        .deepdive-score-change.negative {
            background: rgba(255, 95, 87, 0.12);
            color: #ff5f57;
        }
        
        /* Typing indicator */
        .deepdive-typing {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            width: fit-content;
        }
        
        .deepdive-typing.hidden { display: none; }
        
        .deepdive-typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-tertiary);
            animation: typingBounce 1.4s ease infinite;
        }
        
        .deepdive-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .deepdive-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        
        /* Input area */
        .deepdive-input-area {
            padding: 16px clamp(20px, 4vw, 48px);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .deepdive-input-container {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 8px 8px 8px 20px;
            transition: border-color 0.2s ease;
        }
        
        .deepdive-input-container:focus-within {
            border-color: var(--text-secondary);
        }
        
        .deepdive-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 15px;
            font-family: inherit;
            color: var(--text);
            outline: none;
            resize: none;
            max-height: 120px;
            line-height: 1.4;
            padding: 6px 0;
        }
        
        .deepdive-input::placeholder {
            color: var(--text-tertiary);
        }
        
        .deepdive-send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--btn-bg);
            color: var(--btn-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .deepdive-send-btn:hover {
            transform: scale(1.05);
        }
        
        .deepdive-send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }
        
        .deepdive-send-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .deepdive-voice-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .deepdive-voice-btn:hover {
            background: var(--badge-bg);
        }
        
        .deepdive-voice-btn.recording {
            background: #ff5f57;
            border-color: #ff5f57;
            color: white;
            animation: voicePulse 1.5s ease infinite;
        }
        
        @keyframes voicePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 95, 87, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 95, 87, 0); }
        }
        
        .deepdive-voice-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .deepdive-end-btn {
            padding: 12px 20px;
            border-radius: 100px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .deepdive-end-btn:hover {
            background: var(--btn-bg);
            color: var(--btn-text);
            border-color: var(--btn-bg);
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .deepdive-split {
                flex-direction: column;
            }
            
            .deepdive-panel-left {
                width: 100%;
                min-width: unset;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 200px;
                padding: 16px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 12px;
                overflow-x: auto;
            }
            
            .deepdive-context-section {
                min-width: 200px;
            }
            
            .deepdive-context-section:first-child {
                min-width: 100%;
            }
            
            .deepdive-professor-note {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .deepdive-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .deepdive-score-container {
                align-self: flex-end;
                margin-top: -48px;
            }
            
            .deepdive-panel-left {
                display: none;
            }
            
            .deepdive-message-bubble {
                font-size: 14px;
                padding: 12px 16px;
            }
            
            .deepdive-input-area {
                padding: 12px 16px;
            }
        }
        
        /* Score Reveal Overlay */
        .score-reveal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .score-reveal-overlay.visible {
            opacity: 1;
        }
        
        .score-reveal-content {
            text-align: center;
            color: white;
        }
        
        .score-reveal-label {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            opacity: 0.6;
            margin-bottom: 24px;
        }
        
        .score-reveal-ring {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 24px;
        }
        
        .score-reveal-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .score-reveal-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 8;
        }
        
        .score-reveal-fill {
            fill: none;
            stroke: white;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.1s ease;
        }
        
        .score-reveal-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: 700;
            font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
        }
        
        .score-reveal-change {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .score-reveal-change.positive {
            color: #28c840;
        }
        
        .score-reveal-change.negative {
            color: #ff5f57;
        }
        
        .score-reveal-note {
            font-size: 15px;
            opacity: 0.6;
            margin-bottom: 32px;
        }
        
        .score-reveal-btn {
            background: white;
            color: black;
            border: none;
            padding: 14px 48px;
            border-radius: 100px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        
        .score-reveal-btn:hover {
            transform: scale(1.05);
        }
        
        /* ============ SYNC VIEW ============ */
        .sync-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 20;
            background: var(--bg);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sync-view.visible { display: flex; }
        
        .sync-header {
            padding: 16px clamp(16px, 3vw, 32px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .sync-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sync-back {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: all 0.2s;
        }
        
        .sync-back:hover { background: var(--badge-bg); }
        .sync-back svg { width: 18px; height: 18px; }
        
        .sync-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .sync-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 1px;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .sync-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-tertiary);
        }
        
        .sync-status.recording .sync-status-dot {
            background: #ff5f57;
            animation: pulse 1.5s ease infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Split Layout */
        .sync-split {
            flex: 1;
            display: flex;
            min-height: 0;
        }
        
        /* Left Panel - Sources */
        .sync-panel-left {
            width: 280px;
            min-width: 280px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
        }
        
        .sync-sources-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sync-sources-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }
        
        .sync-sources-count {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        .sync-sources-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .sync-source-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .sync-source-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .sync-source-icon svg { width: 18px; height: 18px; }
        
        .sync-source-icon.audio { background: rgba(88, 86, 214, 0.12); color: #5856d6; }
        .sync-source-icon.slides { background: rgba(255, 149, 0, 0.12); color: #ff9500; }
        .sync-source-icon.notes { background: rgba(40, 200, 64, 0.12); color: #28c840; }
        
        .sync-source-info { flex: 1; min-width: 0; }
        .sync-source-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sync-source-meta { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }
        
        .sync-upload-options {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }
        
        .sync-upload-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .sync-upload-btn:hover {
            background: var(--badge-bg);
            color: var(--text);
        }
        
        .sync-upload-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sync-upload-icon svg { width: 16px; height: 16px; }
        .sync-upload-icon.upload { background: rgba(88, 86, 214, 0.12); color: #5856d6; }
        .sync-upload-icon.slides { background: rgba(255, 149, 0, 0.12); color: #ff9500; }
        .sync-upload-icon.notes { background: rgba(40, 200, 64, 0.12); color: #28c840; }
        
        /* Right Panel - Recording */
        .sync-panel-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Initial Record Prompt */
        .sync-record-prompt {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .sync-record-prompt.hidden { display: none; }
        
        .sync-record-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff5f57, #ff2d55);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(255, 95, 87, 0.3);
        }
        
        .sync-record-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 12px 40px rgba(255, 95, 87, 0.4);
        }
        
        .sync-record-btn svg {
            width: 40px;
            height: 40px;
        }
        
        .sync-record-label {
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        /* Recording Panel */
        .sync-recording-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .sync-recording-panel.hidden { display: none; }
        
        .sync-transcript-feed {
            flex: 1;
            padding: 32px clamp(24px, 4vw, 48px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .sync-transcript-line {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 20px;
            line-height: 1.5;
            color: var(--text);
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .sync-transcript-line.fading {
            color: var(--text-tertiary);
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .sync-recording-controls {
            padding: 24px clamp(24px, 4vw, 48px);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 20px;
            background: var(--bg-card);
        }
        
        .sync-waveform-container {
            flex: 1;
            height: 48px;
            display: flex;
            align-items: center;
        }
        
        .sync-waveform-bars {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 100%;
            width: 100%;
        }
        
        .sync-waveform-bar {
            flex: 1;
            max-width: 4px;
            background: var(--text);
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        
        .sync-timer {
            font-size: 24px;
            font-weight: 600;
            font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
            min-width: 80px;
            text-align: center;
        }
        
        .sync-stop-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: none;
            background: #ff5f57;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .sync-stop-btn:hover {
            transform: scale(1.05);
        }
        
        .sync-stop-btn svg {
            width: 20px;
            height: 20px;
        }
        
        /* Processing Panel */
        .sync-processing-panel {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sync-processing-panel.hidden { display: none; }
        
        .sync-processing-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 300px;
        }
        
        .sync-processing-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .sync-processing-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .sync-processing-progress {
            width: 100%;
            height: 4px;
            background: var(--badge-bg);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .sync-progress-bar {
            height: 100%;
            width: 0%;
            background: var(--text);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .processing-spinner.large {
            width: 48px;
            height: 48px;
            border-width: 3px;
        }
        
        /* Complete Panel */
        .sync-complete-panel {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sync-complete-panel.hidden { display: none; }
        
        .sync-complete-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }
        
        .sync-complete-icon {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(40, 200, 64, 0.12);
            color: #28c840;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sync-complete-icon svg {
            width: 36px;
            height: 36px;
        }
        
        .sync-complete-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .sync-complete-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .sync-complete-concepts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }
        
        .sync-concept-tag {
            padding: 8px 14px;
            background: var(--badge-bg);
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .sync-done-btn {
            margin-top: 16px;
            padding: 14px 48px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 100px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sync-done-btn:hover {
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .sync-split {
                flex-direction: column;
            }
            
            .sync-panel-left {
                width: 100%;
                min-width: unset;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .sync-upload-options {
                padding: 12px;
            }
        }
        
        /* Course stats */
        .course-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        
        .course-stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
        }
        
        .course-stat-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }
        
        .course-stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Concepts grid */
        .concepts-section {}
        
        .concepts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .concepts-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .concepts-filter {
            display: flex;
            gap: 4px;
            background: var(--bg);
            padding: 4px;
            border-radius: 8px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: var(--bg-card);
            color: var(--text);
        }
        
        .concepts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        
        .concept-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .concept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .concept-progress-ring {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
            position: relative;
        }
        
        .concept-progress-ring svg {
            transform: rotate(-90deg);
        }
        
        .concept-progress-ring circle {
            fill: none;
            stroke-width: 4;
        }
        
        .concept-progress-ring .bg { stroke: var(--bg); }
        .concept-progress-ring .progress { stroke: var(--text); stroke-linecap: round; }
        
        .concept-progress-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }
        
        .concept-info { 
            flex: 1; 
            min-width: 0;
        }
        .concept-name { 
            font-size: 14px; 
            font-weight: 500; 
            margin-bottom: 4px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .concept-status { 
            font-size: 11px; 
            color: var(--text-tertiary); 
            white-space: nowrap;
        }
        
        .concept-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .concept-arrow {
            color: var(--text-tertiary);
            transition: transform 0.2s ease;
        }
        
        .concept-card:hover .concept-arrow {
            transform: translateX(2px);
            color: var(--text-secondary);
        }
        
        .concept-arrow svg { width: 16px; height: 16px; }
        
        /* Session notes */
        .sessions-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
        }
        
        .sessions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .sessions-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .session-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .session-item:hover { background: var(--badge-bg); }
        
        .session-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .session-icon svg { width: 18px; height: 18px; color: var(--text-secondary); }
        
        .session-info { flex: 1; }
        .session-topic { font-size: 14px; font-weight: 500; margin-bottom: 2px; }
        .session-meta { font-size: 11px; color: var(--text-tertiary); }
        
        .session-duration {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* ===================== */
        /* STUDIO - NEW DESIGN   */
        /* ===================== */
        
        .studio-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }
        
        .studio-sidebar {
            width: 220px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, width 0.3s ease;
        }
        
        .studio-sidebar.collapsed {
            width: 0;
            transform: translateX(-220px);
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-logo {
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        
        .sidebar-section {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .sidebar-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-tertiary);
            padding: 0 12px;
            margin-bottom: 8px;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover { background: var(--badge-bg); color: var(--text); }
        .sidebar-item.active { background: var(--btn-bg); color: var(--btn-text); }
        .sidebar-item svg { width: 16px; height: 16px; }
        
        .project-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .project-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 2px;
            transition: all 0.2s ease;
        }
        
        .project-item:hover, .project-item.active { background: var(--badge-bg); }
        
        .project-thumb {
            width: 32px;
            height: 32px;
            background: var(--bg);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .project-info { flex: 1; min-width: 0; }
        .project-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .project-date { font-size: 10px; color: var(--text-tertiary); margin-top: 2px; }
        
        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }
        
        .btn-new {
            width: 100%;
            padding: 10px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-new svg { width: 14px; height: 14px; }
        
        /* Studio Main */
        .studio-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .studio-header {
            height: 50px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: relative;
        }
        
        .toggle-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .toggle-btn:hover { background: var(--badge-bg); color: var(--text); }
        .toggle-btn svg { width: 16px; height: 16px; }
        
        .studio-header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: 500;
        }
        
        .studio-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Canvas */
        .studio-canvas {
            flex: 1;
            position: relative;
            background: var(--bg);
            overflow: hidden;
        }
        
        .canvas-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.4;
        }
        
        /* Empty State */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -60%);
            text-align: center;
            z-index: 10;
        }
        
        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: var(--bg-card);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
        }
        
        .empty-icon svg { width: 28px; height: 28px; color: var(--text-tertiary); }
        .empty-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .empty-desc { font-size: 13px; color: var(--text-secondary); max-width: 280px; line-height: 1.5; }
        
        /* Conversation Bubble - Now fixed above waveform */
        .dialogue-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            z-index: 25;
        }
        
        .generations-carousel {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow-x: auto;
            background: linear-gradient(to bottom, transparent 0%, var(--bg) 30%);
        }
        
        .generations-carousel::-webkit-scrollbar { display: none; }
        
        .generation-item {
            width: 52px;
            height: 52px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .generation-item:hover { border-color: var(--text-secondary); transform: translateY(-2px); }
        .generation-item.active { border-color: var(--text); box-shadow: 0 4px 12px var(--shadow); }
        .generation-item.add-new { border-style: dashed; }
        .generation-item.add-new svg { width: 16px; height: 16px; color: var(--text-tertiary); }
        
        .dialogue-box {
            margin: 0 20px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            min-height: 60px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .dialogue-label {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }
        
        .dialogue-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text);
        }
        
        .dialogue-text.empty {
            color: var(--text-tertiary);
            font-style: italic;
        }
        
        /* Recording Indicator */
        .recording-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .recording-indicator.visible { opacity: 1; }
        
        .recording-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-dot 1s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Waveform */
        .waveform-container {
            padding: 12px 20px 16px;
            background: var(--bg-card);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            cursor: pointer;
            border-top: 1px solid var(--border);
        }
        
        .waveform-bar {
            width: 100%;
            height: 36px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
        }
        
        .waveform-line {
            width: 3px;
            background: rgba(var(--waveform), 0.2);
            border-radius: 3px;
            transition: height 0.05s ease, background 0.2s ease, transform 0.15s ease;
            transform-origin: bottom;
        }
        
        .waveform-container.active .waveform-line {
            background: rgba(var(--waveform), 0.9);
        }
        
        .waveform-container.pulse .waveform-line {
            animation: waveform-pulse 0.3s ease-out;
        }
        
        @keyframes waveform-pulse {
            0% { transform: scaleY(1); }
            50% { transform: scaleY(1.8); }
            100% { transform: scaleY(1); }
        }
        
        /* Text Input Toggle */
        .text-input-toggle {
            position: absolute;
            bottom: 70px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 30;
            transition: all 0.2s ease;
        }
        
        .text-input-toggle:hover {
            background: var(--badge-bg);
            border-color: var(--text-secondary);
        }
        
        .text-input-toggle svg { width: 18px; height: 18px; color: var(--text-secondary); }
        
        /* Edit Mode Toggle */
        .edit-tools {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            z-index: 25;
        }
        
        .edit-tool-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .edit-tool-btn:hover { border-color: var(--text-secondary); }
        .edit-tool-btn.active { background: var(--btn-bg); color: var(--btn-text); border-color: transparent; }
        .edit-tool-btn svg { width: 18px; height: 18px; color: var(--text-secondary); }
        .edit-tool-btn.active svg { color: var(--btn-text); }
        
        /* Edit Boxes */
        .edit-box {
            position: absolute;
            border: 2px solid;
            border-radius: 8px;
            cursor: move;
            transition: box-shadow 0.2s ease;
            z-index: 20;
        }
        
        .edit-box:hover { box-shadow: 0 4px 12px var(--shadow); }
        
        .edit-box-handle {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .edit-box:hover .edit-box-handle { opacity: 1; }
        
        /* Placeholder screens */
        .placeholder-screen {
            text-align: center;
        }
        
        .placeholder-screen h2 { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .placeholder-screen p { color: var(--text-secondary); font-size: 15px; }
        
        /* ===================== */
        /* CONTROLS              */
        /* ===================== */
        
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 200;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover { transform: scale(1.05); }
        .theme-toggle svg { width: 18px; height: 18px; color: var(--text); }
        .theme-toggle .sun-icon { display: none; }
        .theme-toggle .moon-icon { display: block; }
        [data-theme="dark"] .theme-toggle .sun-icon { display: block; }
        [data-theme="dark"] .theme-toggle .moon-icon { display: none; }
        
        
        
        
        
        /* ===================== */
        /* RESPONSIVE DESIGN     */
        /* ===================== */
        
        /* Small screens (mobile) */
        @media (max-width: 768px) {
            .app-main {
                padding: 12px;
            }
            
            .academy-dashboard-layout {
                gap: 20px;
            }
            
            /* Tools carousel - 2x2 grid on mobile */
            .tools-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 0 20px;
                width: 100%;
                max-width: 500px;
            }
            
            .tool-card {
                height: 180px;
            }
            
            .tool-content {
                padding: 20px 16px;
            }
            
            .tool-icon-wrapper {
                margin-top: 16px;
            }
            
            .tool-icon {
                width: 28px;
                height: 28px;
            }
            
            .tool-title {
                margin-top: 12px;
                font-size: 15px;
            }
            
            .tool-subtitle {
                font-size: 10px;
                margin-top: 4px;
            }
            
            .coming-soon {
                bottom: 12px;
                font-size: 8px;
            }
            
            /* Stack courses and needs attention vertically */
            .dashboard-top {
                flex-direction: column;
                gap: 16px;
            }
            
            /* Needs attention becomes horizontal scroll row */
            .needs-attention-sidebar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                gap: 10px;
                padding-bottom: 4px;
                -webkit-overflow-scrolling: touch;
            }
            
            .attention-section-title {
                display: none;
            }
            
            .attention-card {
                min-width: 180px;
                flex-shrink: 0;
                padding: 12px;
            }
            
            .attention-card-name {
                font-size: 13px;
            }
            
            /* Calendar stacks vertically on mobile */
            .today-expanded-content {
                flex-direction: column;
                gap: 16px;
            }
            
            .calendar-mini {
                width: 100%;
                min-width: unset;
                max-width: 100%;
            }
            
            /* Today bar adjustments */
            .today-bar {
                margin-top: 8px;
            }
            
            .today-bar-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
                padding: 12px 16px;
            }
            
            .today-tasks-preview {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .today-task-chip {
                font-size: 11px;
                padding: 6px 10px;
            }
            
            .today-expanded {
                padding: 16px;
            }
            
            /* Header adjustments */
            .dashboard-title {
                font-size: 24px;
            }
            
            .dashboard-greeting {
                font-size: 12px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            /* Course cards */
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .course-card {
                padding: 18px;
            }
            
            .course-card-name {
                font-size: 16px;
            }
            
            .add-card {
                min-height: 100px;
            }
            
            /* Analytics */
            .charts-row {
                grid-template-columns: 1fr;
            }
            
            .analytics-row {
                grid-template-columns: 1fr;
            }
            
            .analytics-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .analytics-card {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .stat-card {
                padding: 14px;
            }
            
            /* Course detail */
            .course-detail-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .course-detail-actions {
                width: 100%;
            }
            
            .course-detail-name {
                font-size: 22px;
            }
            
            .concepts-grid {
                grid-template-columns: 1fr;
            }
            
            .concept-card {
                padding: 12px;
            }
            
            /* App header */
            .app-header {
                padding: 0 12px;
            }
            
            .header-badge {
                display: none;
            }
            
            /* Onboarding */
            .onboard-title {
                font-size: 28px;
            }
            
            .input-row {
                flex-wrap: wrap;
            }
            
            .input-lg {
                width: 100%;
                flex: none;
            }
        }
        
        /* Very narrow screens (phone portrait / extreme narrow split) */
        @media (max-width: 420px) {
            .app-main {
                padding: 8px;
            }
            
            /* Tools stay 2-column but shorter on very narrow */
            .tools-container {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 0 20px;
                width: 100%;
                max-width: 280px;
            }
            
            .tool-card {
                height: 200px;
            }
            
            .tool-icon-wrapper {
                margin-top: 24px;
            }
            
            .tool-content {
                padding: 24px 20px;
            }
            
            .tool-title {
                margin-top: 14px;
                font-size: 18px;
            }
            
            .tool-subtitle {
                margin-top: 6px;
                font-size: 12px;
            }
            
            .coming-soon {
                bottom: 18px;
                font-size: 8px;
            }
            
            .dashboard-title {
                font-size: 20px;
            }
            
            .today-bar-header {
                padding: 10px 12px;
            }
            
            .today-expanded {
                padding: 12px;
            }
            
            .calendar-day {
                font-size: 11px;
            }
            
            .task-item {
                padding: 10px;
                gap: 8px;
            }
            
            .task-title {
                font-size: 12px;
            }
            
            .task-time {
                font-size: 11px;
                min-width: 50px;
            }
            
            .btn-analytics {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .onboard-title {
                font-size: 24px;
            }
            
            .onboard-subtitle {
                font-size: 14px;
            }
        }
        
        /* Medium screens (tablet/small laptop) */
        @media (min-width: 769px) and (max-width: 1200px) {
            /* Tools go 2x2 when 4 columns don't fit */
            .tools-container {
                grid-template-columns: repeat(2, 240px);
                width: fit-content;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
            
            .needs-attention-sidebar {
                width: 240px;
            }
        }
        
        /* Large screens (desktop/external monitor) */
        @media (min-width: 1600px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
            
            .concepts-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
            
            .charts-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Ultra-wide screens (30"+ monitors) */
        @media (min-width: 2200px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            }
            
            .concepts-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>
    
    <!-- Typing intro + auth removed — marketing page handles intro, wizard handles auth -->
    
    <!-- Welcome Screen -->
    <div class="screen" id="welcome-screen">
        <h1 class="welcome-text">Welcome back, Deji</h1>
    </div>
    
    <!-- Tools Screen -->
    <div class="screen" id="tools-screen">
        <div class="tools-container">
            <div class="tool-card" onclick="openApp('academy')">
                <div class="tool-content">
                    <div class="tool-icon-wrapper">
                        <svg class="tool-icon" viewBox="0 0 56 56" fill="none">
                            <polygon points="28,6 33,22 50,22 36,32 41,48 28,38 15,48 20,32 6,22 23,22" class="icon-fill"/>
                        </svg>
                    </div>
                    <h2 class="tool-title">ACADEMY</h2>
                    <p class="tool-subtitle">Master concepts through conversation</p>
                </div>
            </div>
            
            <div class="tool-card" onclick="openApp('studio')">
                <div class="tool-content">
                    <div class="tool-icon-wrapper">
                        <svg class="tool-icon" viewBox="0 0 56 56" fill="none">
                            <rect x="8" y="16" width="28" height="28" rx="2" class="icon-stroke" stroke-width="2.5" fill="none"/>
                            <rect x="20" y="8" width="28" height="28" rx="2" class="icon-fill"/>
                            <line x1="26" y1="18" x2="42" y2="18" class="icon-inner" stroke-width="2" stroke-linecap="round"/>
                            <line x1="26" y1="24" x2="38" y2="24" class="icon-inner" stroke-width="2" stroke-linecap="round"/>
                            <line x1="26" y1="30" x2="34" y2="30" class="icon-inner" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2 class="tool-title">STUDIO</h2>
                    <p class="tool-subtitle">Design documentation, visualized</p>
                </div>
                <span class="coming-soon">Coming Soon</span>
            </div>
            
            <div class="tool-card" onclick="openApp('shell')">
                <div class="tool-content">
                    <div class="tool-icon-wrapper">
                        <svg class="tool-icon" viewBox="0 0 56 56" fill="none">
                            <rect x="6" y="10" width="44" height="36" rx="4" class="icon-stroke" stroke-width="2.5" fill="none"/>
                            <path d="M16 24l8 6-8 6" class="icon-stroke" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="28" y1="36" x2="40" y2="36" class="icon-stroke" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2 class="tool-title">SHELL</h2>
                    <p class="tool-subtitle">Build, debug, document code</p>
                </div>
                <span class="coming-soon">Coming Soon</span>
            </div>
            
            <div class="tool-card" onclick="openApp('flow')">
                <div class="tool-content">
                    <div class="tool-icon-wrapper">
                        <svg class="tool-icon" viewBox="0 0 56 56" fill="none">
                            <circle cx="14" cy="28" r="5" class="icon-fill"/>
                            <circle cx="28" cy="14" r="5" class="icon-fill"/>
                            <circle cx="42" cy="28" r="5" class="icon-fill"/>
                            <circle cx="28" cy="42" r="5" class="icon-fill"/>
                            <line x1="14" y1="28" x2="28" y2="14" class="icon-stroke" stroke-width="2" stroke-linecap="round"/>
                            <line x1="28" y1="14" x2="42" y2="28" class="icon-stroke" stroke-width="2" stroke-linecap="round"/>
                            <line x1="42" y1="28" x2="28" y2="42" class="icon-stroke" stroke-width="2" stroke-linecap="round"/>
                            <line x1="28" y1="42" x2="14" y2="28" class="icon-stroke" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2 class="tool-title">FLOW</h2>
                    <p class="tool-subtitle">Automate the repetitive</p>
                </div>
                <span class="coming-soon">Coming Soon</span>
            </div>
        </div>
    </div>
    
    <!-- Academy -->
    <div class="app-container" id="academy-app">
        <header class="app-header">
            <div class="header-left">
                <button class="back-btn" onclick="exitApp()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                </button>
                <div class="header-logo">
                    <span class="header-logo-text">ACADEMY</span>
                    <span class="header-badge">Beta</span>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
                <div class="settings-container">
                    <button class="header-btn settings-btn" onclick="toggleSettings()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </button>
                    <div class="settings-dropdown" id="settings-dropdown">
                        <div class="settings-dropdown-header">Settings</div>
                        <div class="settings-item" onclick="window.location.hash='account'">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <span>Account</span>
                        </div>
                        <div class="settings-item" onclick="window.location.hash='data'">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            <span>Data Controls</span>
                        </div>
                        <div class="settings-item" onclick="window.location.hash='notifications'">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                            <span>Notifications</span>
                        </div>
                        <div class="settings-item" onclick="window.location.hash='integrations'">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                            <span>Integrations</span>
                        </div>
                        <div class="settings-divider"></div>
                        <div class="settings-item theme-toggle" onclick="toggleDarkMode()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="theme-icon-settings">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                            <span id="theme-label-settings">Dark Mode</span>
                            <div class="settings-toggle" id="theme-toggle-settings">
                                <div class="settings-toggle-knob"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="avatar">DJ</div>
            </div>
        </header>
        <main class="app-main">
            <div class="onboard-container" id="academy-new">
                <div class="onboard-header">
                    <p class="onboard-label">Let's get started</p>
                    <h1 class="onboard-title">What are you learning<br>this semester?</h1>
                    <p class="onboard-subtitle">Add your courses and we'll help you master each one.</p>
                </div>
                <div class="input-card">
                    <div class="input-card-header">
                        <span class="input-card-title">Your Courses</span>
                        <span class="input-card-count" id="course-count">0 courses</span>
                    </div>
                    <div class="tags-area" id="course-tags"></div>
                    
                    <!-- Syllabus Upload Area -->
                    <div class="syllabus-upload" id="syllabus-upload" onclick="document.getElementById('syllabus-input').click()">
                        <input type="file" id="syllabus-input" accept=".pdf,.doc,.docx" style="display:none" onchange="handleSyllabusUpload(event)">
                        <div class="syllabus-upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="12" y1="18" x2="12" y2="12"/>
                                <line x1="9" y1="15" x2="12" y2="12"/>
                                <line x1="15" y1="15" x2="12" y2="12"/>
                            </svg>
                        </div>
                        <div class="syllabus-upload-text">
                            <span class="syllabus-upload-title">Drop your syllabus here</span>
                            <span class="syllabus-upload-hint">PDF or Word • We'll extract course details automatically</span>
                        </div>
                    </div>
                    
                    <!-- Processing state -->
                    <div class="syllabus-processing hidden" id="syllabus-processing">
                        <div class="processing-spinner"></div>
                        <span>Reading syllabus...</span>
                    </div>
                    
                    <p class="input-hint">Or add manually:</p>
                    <div class="input-row input-row-compact">
                        <input type="text" class="input-sm" id="c-prefix" placeholder="ARC" maxlength="4" />
                        <input type="text" class="input-md" id="c-number" placeholder="418" maxlength="4" />
                        <button class="btn-add" onclick="addCourseManual()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                </div>
                <div class="continue-section">
                    <button class="btn-continue" id="btn-continue" onclick="finishOnboarding()">
                        Continue
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                    </button>
                    <p class="continue-hint">Add at least one course to continue</p>
                </div>
            </div>
            <div class="academy-dashboard-layout" id="academy-dashboard" style="display:none;">
                <div class="dashboard-header">
                    <div class="dashboard-header-left">
                        <p class="dashboard-greeting">Welcome back, Deji</p>
                        <h1 class="dashboard-title">Your Courses</h1>
                    </div>
                    <div class="dashboard-header-right">
                        <button class="btn-analytics" onclick="openAnalytics()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                            Analytics
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-top">
                    <div class="dashboard-main">
                        <div class="dashboard-grid" id="courses-grid"></div>
                    </div>
                    
                    <!-- Needs Attention - Now on right -->
                    <div class="needs-attention-sidebar">
                        <span class="attention-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            Needs Attention
                        </span>
                        <div class="attention-card critical">
                            <div class="attention-card-header">
                                <span class="attention-card-code">ARC 401</span>
                                <span class="attention-card-percent">45%</span>
                            </div>
                            <div class="attention-card-name">Studio V</div>
                            <div class="attention-card-reason">No sessions in 5 days</div>
                        </div>
                        <div class="attention-card">
                            <div class="attention-card-header">
                                <span class="attention-card-code">ARC 342</span>
                                <span class="attention-card-percent">58%</span>
                            </div>
                            <div class="attention-card-name">Construction Methods</div>
                            <div class="attention-card-reason">Below 60% mastery</div>
                        </div>
                    </div>
                </div>
                
                <!-- Today Bar - Full width at bottom -->
                <div class="today-bar" id="today-bar">
                    <div class="today-bar-header">
                        <div class="today-bar-left">
                            <div class="today-date">
                                <span class="today-date-day">31</span>
                                <span class="today-date-month">Jan</span>
                            </div>
                            <div class="today-info">
                                <div class="today-label">Today's Schedule</div>
                                <div class="today-summary">3 tasks remaining</div>
                            </div>
                        </div>
                        <div class="today-tasks-preview">
                            <div class="today-task-chip">
                                <span class="task-dot" style="background: #3b82f6;"></span>
                                Midterm Exam
                            </div>
                            <div class="today-task-chip">
                                <span class="task-dot" style="background: #22c55e;"></span>
                                Studio Pin-Up
                            </div>
                            <div class="today-task-chip">
                                <span class="task-dot" style="background: #f59e0b;"></span>
                                Essay Due
                            </div>
                        </div>
                    </div>
                    <div class="today-expanded">
                        <div class="today-expanded-content">
                            <div class="calendar-mini">
                                <div class="calendar-mini-header">
                                    <span class="calendar-mini-title">January 2026</span>
                                    <div class="calendar-mini-nav">
                                        <button><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                                        <button><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                                    </div>
                                </div>
                                <div class="calendar-weekdays">
                                    <span class="calendar-weekday">S</span>
                                    <span class="calendar-weekday">M</span>
                                    <span class="calendar-weekday">T</span>
                                    <span class="calendar-weekday">W</span>
                                    <span class="calendar-weekday">T</span>
                                    <span class="calendar-weekday">F</span>
                                    <span class="calendar-weekday">S</span>
                                </div>
                                <div class="calendar-days">
                                    <div class="calendar-day other-month">29</div>
                                    <div class="calendar-day other-month">30</div>
                                    <div class="calendar-day other-month">31</div>
                                    <div class="calendar-day">1</div>
                                    <div class="calendar-day">2</div>
                                    <div class="calendar-day busy-2 has-event">3</div>
                                    <div class="calendar-day">4</div>
                                    <div class="calendar-day busy-1">5</div>
                                    <div class="calendar-day busy-1 has-event">6</div>
                                    <div class="calendar-day">7</div>
                                    <div class="calendar-day busy-1">8</div>
                                    <div class="calendar-day">9</div>
                                    <div class="calendar-day busy-3 has-event">10</div>
                                    <div class="calendar-day">11</div>
                                    <div class="calendar-day">12</div>
                                    <div class="calendar-day busy-1">13</div>
                                    <div class="calendar-day busy-2 has-event">14</div>
                                    <div class="calendar-day">15</div>
                                    <div class="calendar-day">16</div>
                                    <div class="calendar-day busy-1">17</div>
                                    <div class="calendar-day">18</div>
                                    <div class="calendar-day">19</div>
                                    <div class="calendar-day busy-2 has-event">20</div>
                                    <div class="calendar-day">21</div>
                                    <div class="calendar-day">22</div>
                                    <div class="calendar-day busy-1">23</div>
                                    <div class="calendar-day">24</div>
                                    <div class="calendar-day">25</div>
                                    <div class="calendar-day">26</div>
                                    <div class="calendar-day busy-1">27</div>
                                    <div class="calendar-day busy-3 has-event">28</div>
                                    <div class="calendar-day">29</div>
                                    <div class="calendar-day">30</div>
                                    <div class="calendar-day today busy-3 has-event">31</div>
                                </div>
                            </div>
                            <div class="tasks-list">
                                <div class="tasks-list-header">Today's Tasks</div>
                                <div class="task-item">
                                    <div class="task-dot-lg" style="background: #3b82f6;"></div>
                                    <div class="task-time">9:00 AM</div>
                                    <div class="task-details">
                                        <div class="task-title">Midterm Exam</div>
                                        <div class="task-course">ARC 418 — Latin American Architecture</div>
                                    </div>
                                </div>
                                <div class="task-item">
                                    <div class="task-dot-lg" style="background: #22c55e;"></div>
                                    <div class="task-time">2:00 PM</div>
                                    <div class="task-details">
                                        <div class="task-title">Studio Pin-Up</div>
                                        <div class="task-course">ARC 401 — Studio V</div>
                                    </div>
                                </div>
                                <div class="task-item">
                                    <div class="task-dot-lg" style="background: #f59e0b;"></div>
                                    <div class="task-time">11:59 PM</div>
                                    <div class="task-details">
                                        <div class="task-title">Essay Due</div>
                                        <div class="task-course">POL 241 — Political Science</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics View -->
            <div class="analytics-view" id="analytics-view">
                <div class="analytics-header">
                    <div class="analytics-header-left">
                        <div class="analytics-back" onclick="closeAnalytics()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                            Back to Courses
                        </div>
                        <h1 class="analytics-title">Analytics</h1>
                    </div>
                    <div class="analytics-period">
                        <button class="period-btn">Week</button>
                        <button class="period-btn active">Month</button>
                        <button class="period-btn">Semester</button>
                    </div>
                </div>
                
                <div class="analytics-grid">
                    <div class="stat-card">
                        <div class="stat-label">Latency Score</div>
                        <div class="stat-value">68%</div>
                        <div class="stat-trend up">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                            +12% this month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Study Sessions</div>
                        <div class="stat-value">41</div>
                        <div class="stat-trend up">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                            +8 from last month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg. Test Score</div>
                        <div class="stat-value">82</div>
                        <div class="stat-trend up">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                            +5 points
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Retention Rate</div>
                        <div class="stat-value">74%</div>
                        <div class="stat-trend down">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/></svg>
                            -3% this week
                        </div>
                    </div>
                </div>
                
                <div class="analytics-row">
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <span class="analytics-card-title">Test Score Trend</span>
                            <span class="analytics-card-action">View all tests →</span>
                        </div>
                        <div class="chart-area" id="test-score-chart">
                            <div class="your-position">
                                <span class="position-dot"></span>
                                You: 82 • Class avg: 76
                            </div>
                            <svg class="chart-svg" viewBox="0 0 300 140" preserveAspectRatio="none">
                                <defs>
                                    <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:var(--text);stop-opacity:0.3"/>
                                        <stop offset="100%" style="stop-color:var(--text);stop-opacity:0"/>
                                    </linearGradient>
                                </defs>
                                <!-- Class average line (dashed) -->
                                <path class="chart-line class-avg animate" d="M 20,85 L 60,80 L 100,88 L 140,82 L 180,78 L 220,80 L 260,76" />
                                <!-- Your score line -->
                                <path class="chart-line user animate" d="M 20,95 L 60,75 L 100,85 L 140,60 L 180,70 L 220,50 L 260,55" />
                                <!-- Your position dot -->
                                <circle class="chart-dot animate" cx="260" cy="55" r="6"/>
                                <!-- Class position dot -->
                                <circle class="chart-dot class-dot animate" cx="260" cy="76" r="4"/>
                            </svg>
                            <div class="chart-labels">
                                <span>Sep</span><span>Oct</span><span>Nov</span><span>Dec</span><span>Jan</span>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item"><div class="legend-line solid"></div>You</div>
                                <div class="legend-item"><div class="legend-line dashed"></div>Class</div>
                            </div>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <span class="analytics-card-title">Latency Score Trend</span>
                            <span class="analytics-card-action">View details →</span>
                        </div>
                        <div class="chart-area" id="latency-chart">
                            <div class="your-position">
                                <span class="position-dot"></span>
                                You: 68% • Class avg: 61%
                            </div>
                            <svg class="chart-svg" viewBox="0 0 300 140" preserveAspectRatio="none">
                                <!-- Class average line (dashed) -->
                                <path class="chart-line class-avg animate" d="M 20,90 L 60,88 L 100,85 L 140,80 L 180,75 L 220,72 L 260,70" />
                                <!-- Your latency line -->
                                <path class="chart-line user animate" d="M 20,100 L 60,85 L 100,80 L 140,65 L 180,58 L 220,52 L 260,48" />
                                <!-- Your position dot -->
                                <circle class="chart-dot animate" cx="260" cy="48" r="6"/>
                                <!-- Class position dot -->
                                <circle class="chart-dot class-dot animate" cx="260" cy="70" r="4"/>
                            </svg>
                            <div class="chart-labels">
                                <span>Sep</span><span>Oct</span><span>Nov</span><span>Dec</span><span>Jan</span>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item"><div class="legend-line solid"></div>You</div>
                                <div class="legend-item"><div class="legend-line dashed"></div>Class</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-row">
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <span class="analytics-card-title">Struggling</span>
                            <span class="analytics-card-action">View all →</span>
                        </div>
                        <div class="topics-list">
                            <div class="topic-item">
                                <div class="topic-status struggling"></div>
                                <div class="topic-info">
                                    <div class="topic-name">Brutalist Movement Origins</div>
                                    <div class="topic-course">ARC 418</div>
                                </div>
                                <span class="topic-percent">32%</span>
                            </div>
                            <div class="topic-item">
                                <div class="topic-status struggling"></div>
                                <div class="topic-info">
                                    <div class="topic-name">Load Distribution</div>
                                    <div class="topic-course">ARC 342</div>
                                </div>
                                <span class="topic-percent">41%</span>
                            </div>
                            <div class="topic-item">
                                <div class="topic-status learning"></div>
                                <div class="topic-info">
                                    <div class="topic-name">Democratic Theory</div>
                                    <div class="topic-course">POL 241</div>
                                </div>
                                <span class="topic-percent">55%</span>
                            </div>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <span class="analytics-card-title">Mastered</span>
                            <span class="analytics-card-action">View all →</span>
                        </div>
                        <div class="topics-list">
                            <div class="topic-item">
                                <div class="topic-status mastered"></div>
                                <div class="topic-info">
                                    <div class="topic-name">Barragán's Color Theory</div>
                                    <div class="topic-course">ARC 418</div>
                                </div>
                                <span class="topic-percent">94%</span>
                            </div>
                            <div class="topic-item">
                                <div class="topic-status mastered"></div>
                                <div class="topic-info">
                                    <div class="topic-name">Steel Frame Construction</div>
                                    <div class="topic-course">ARC 342</div>
                                </div>
                                <span class="topic-percent">88%</span>
                            </div>
                            <div class="topic-item">
                                <div class="topic-status mastered"></div>
                                <div class="topic-info">
                                    <div class="topic-name">Federalism Principles</div>
                                    <div class="topic-course">POL 241</div>
                                </div>
                                <span class="topic-percent">91%</span>
                            </div>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <span class="analytics-card-title">Retention</span>
                        </div>
                        <div class="retention-grid">
                            <div class="retention-day level-2">M</div>
                            <div class="retention-day level-4">T</div>
                            <div class="retention-day level-3">W</div>
                            <div class="retention-day level-1">T</div>
                            <div class="retention-day level-4">F</div>
                            <div class="retention-day level-0">S</div>
                            <div class="retention-day level-2">S</div>
                            <div class="retention-day level-3">M</div>
                            <div class="retention-day level-4">T</div>
                            <div class="retention-day level-2">W</div>
                            <div class="retention-day level-4">T</div>
                            <div class="retention-day level-3">F</div>
                            <div class="retention-day level-1">S</div>
                            <div class="retention-day level-0">S</div>
                            <div class="retention-day level-2">M</div>
                            <div class="retention-day level-3">T</div>
                            <div class="retention-day level-4">W</div>
                            <div class="retention-day level-2">T</div>
                            <div class="retention-day level-1">F</div>
                            <div class="retention-day level-3">S</div>
                            <div class="retention-day level-4">S</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Course Detail View -->
            <div class="course-detail-view" id="course-detail-view">
                <div class="course-detail-header">
                    <div class="course-detail-left">
                        <div class="course-detail-back" onclick="closeCourseDetail()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                            Back to Courses
                        </div>
                        <h1 class="course-detail-name" id="detail-course-name">Latin American Architecture</h1>
                    </div>
                    <div class="course-detail-actions">
                        <button class="btn-sync" onclick="startSync()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
                            Sync
                        </button>
                        <button class="btn-rewind" onclick="openRewind()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 19 2 12 11 5 11 19"/><polygon points="22 19 13 12 22 5 22 19"/></svg>
                            Rewind
                        </button>
                    </div>
                </div>
                
                <div class="course-stats">
                    <div class="course-stat-card">
                        <div class="course-stat-value">72%</div>
                        <div class="course-stat-label">Latency Score</div>
                    </div>
                    <div class="course-stat-card">
                        <div class="course-stat-value">12</div>
                        <div class="course-stat-label">Study Sessions</div>
                    </div>
                    <div class="course-stat-card">
                        <div class="course-stat-value">8/12</div>
                        <div class="course-stat-label">Concepts Learned</div>
                    </div>
                </div>
                
                <div class="concepts-section">
                    <div class="concepts-header">
                        <span class="concepts-title">Concepts</span>
                        <div class="concepts-filter">
                            <button class="filter-btn active">All</button>
                            <button class="filter-btn">Mastered</button>
                            <button class="filter-btn">Learning</button>
                            <button class="filter-btn">Struggling</button>
                        </div>
                    </div>
                    <div class="concepts-grid">
                        <div class="concept-card" onclick="deepDiveConcept('Barragán Color Theory')">
                            <div class="concept-progress-ring">
                                <svg width="48" height="48" viewBox="0 0 48 48">
                                    <circle class="bg" cx="24" cy="24" r="20"/>
                                    <circle class="progress" cx="24" cy="24" r="20" stroke-dasharray="125.6" stroke-dashoffset="7.5"/>
                                </svg>
                                <span class="concept-progress-text">94%</span>
                            </div>
                            <div class="concept-info">
                                <div class="concept-name">Barragán's Color Theory</div>
                                <div class="concept-status">Mastered • Last reviewed 2d ago</div>
                            </div>
                            <div class="concept-actions">
                                <div class="concept-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                            </div>
                        </div>
                        <div class="concept-card" onclick="deepDiveConcept('Mexican Modernism')">
                            <div class="concept-progress-ring">
                                <svg width="48" height="48" viewBox="0 0 48 48">
                                    <circle class="bg" cx="24" cy="24" r="20"/>
                                    <circle class="progress" cx="24" cy="24" r="20" stroke-dasharray="125.6" stroke-dashoffset="25"/>
                                </svg>
                                <span class="concept-progress-text">80%</span>
                            </div>
                            <div class="concept-info">
                                <div class="concept-name">Mexican Modernism</div>
                                <div class="concept-status">Learning • 3 sessions</div>
                            </div>
                            <div class="concept-actions">
                                <div class="concept-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                            </div>
                        </div>
                        <div class="concept-card" onclick="deepDiveConcept('Tropical Architecture')">
                            <div class="concept-progress-ring">
                                <svg width="48" height="48" viewBox="0 0 48 48">
                                    <circle class="bg" cx="24" cy="24" r="20"/>
                                    <circle class="progress" cx="24" cy="24" r="20" stroke-dasharray="125.6" stroke-dashoffset="44"/>
                                </svg>
                                <span class="concept-progress-text">65%</span>
                            </div>
                            <div class="concept-info">
                                <div class="concept-name">Tropical Architecture</div>
                                <div class="concept-status">Learning • Review soon</div>
                            </div>
                            <div class="concept-actions">
                                <div class="concept-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                            </div>
                        </div>
                        <div class="concept-card" onclick="deepDiveConcept('Brutalist Movement')">
                            <div class="concept-progress-ring">
                                <svg width="48" height="48" viewBox="0 0 48 48">
                                    <circle class="bg" cx="24" cy="24" r="20"/>
                                    <circle class="progress" cx="24" cy="24" r="20" stroke-dasharray="125.6" stroke-dashoffset="85"/>
                                </svg>
                                <span class="concept-progress-text">32%</span>
                            </div>
                            <div class="concept-info">
                                <div class="concept-name">Brutalist Movement Origins</div>
                                <div class="concept-status">Struggling • Needs attention</div>
                            </div>
                            <div class="concept-actions">
                                <div class="concept-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="sessions-section">
                    <div class="sessions-header">
                        <span class="sessions-title">Recent Sessions</span>
                        <span class="analytics-card-action">View all →</span>
                    </div>
                    <div class="sessions-list">
                        <div class="session-item">
                            <div class="session-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                            </div>
                            <div class="session-info">
                                <div class="session-topic">Barragán's Casa Gilardi Analysis</div>
                                <div class="session-meta">Today • Deep Dive</div>
                            </div>
                            <span class="session-duration">23 min</span>
                        </div>
                        <div class="session-item">
                            <div class="session-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                            </div>
                            <div class="session-info">
                                <div class="session-topic">Mexican Modernism Overview</div>
                                <div class="session-meta">Yesterday • Deep Dive</div>
                            </div>
                            <span class="session-duration">18 min</span>
                        </div>
                        <div class="session-item">
                            <div class="session-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                            </div>
                            <div class="session-info">
                                <div class="session-topic">Brutalist Origins Review</div>
                                <div class="session-meta">Jan 28 • Deep Dive</div>
                            </div>
                            <span class="session-duration">31 min</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== REWIND VIEW ========== -->
            <div class="rewind-view" id="rewind-view">
                <div class="rewind-header">
                    <div class="rewind-header-left">
                        <button class="rewind-back" onclick="closeRewind()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                        </button>
                        <div>
                            <div class="rewind-title">Rewind</div>
                            <div class="rewind-subtitle" id="rewind-course-name">Latin American Architecture</div>
                        </div>
                    </div>
                    <div class="rewind-header-right">
                        <div class="rewind-mode-toggle">
                            <button class="rewind-mode-btn active" onclick="setRewindMode('options', this)">Options</button>
                            <button class="rewind-mode-btn" onclick="setRewindMode('free', this)">Free Recall</button>
                        </div>
                        <div class="rewind-progress-bar">
                            <span id="rewind-progress-text">Q1 of 3</span>
                            <div class="rewind-progress-track">
                                <div class="rewind-progress-fill" id="rewind-progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="rewind-split">
                    <!-- Left: concepts list -->
                    <div class="rewind-panel-left" id="rewind-panel-left">
                        <div class="rewind-panel-label">Concepts to review</div>
                        <div class="rewind-concept-item active" onclick="selectConcept(0)">
                            <div class="rewind-concept-dot urgent"></div>
                            <div class="rewind-concept-info">
                                <div class="rewind-concept-name">Brutalist Movement Origins</div>
                                <div class="rewind-concept-meta">Struggling • 5 days ago</div>
                            </div>
                            <div class="rewind-concept-score">32%</div>
                        </div>
                        <div class="rewind-concept-item" onclick="selectConcept(1)">
                            <div class="rewind-concept-dot urgent"></div>
                            <div class="rewind-concept-info">
                                <div class="rewind-concept-name">Tropical Architecture</div>
                                <div class="rewind-concept-meta">Declining • Due now</div>
                            </div>
                            <div class="rewind-concept-score">65%</div>
                        </div>
                        <div class="rewind-concept-item" onclick="selectConcept(2)">
                            <div class="rewind-concept-dot due"></div>
                            <div class="rewind-concept-info">
                                <div class="rewind-concept-name">Mexican Modernism</div>
                                <div class="rewind-concept-meta">Due tomorrow • 3 sessions</div>
                            </div>
                            <div class="rewind-concept-score">80%</div>
                        </div>
                        <div class="rewind-concept-item" onclick="selectConcept(3)">
                            <div class="rewind-concept-dot due"></div>
                            <div class="rewind-concept-info">
                                <div class="rewind-concept-name">Post-Revolution Muralism</div>
                                <div class="rewind-concept-meta">Due in 2 days • 2 sessions</div>
                            </div>
                            <div class="rewind-concept-score">58%</div>
                        </div>
                        <div class="rewind-concept-item" onclick="selectConcept(4)">
                            <div class="rewind-concept-dot fresh"></div>
                            <div class="rewind-concept-info">
                                <div class="rewind-concept-name">Barragán's Color Theory</div>
                                <div class="rewind-concept-meta">Mastered • 2 days ago</div>
                            </div>
                            <div class="rewind-concept-score">94%</div>
                        </div>
                        <div class="rewind-concept-item" onclick="selectConcept(5)">
                            <div class="rewind-concept-dot fresh"></div>
                            <div class="rewind-concept-info">
                                <div class="rewind-concept-name">Climate-Responsive Design</div>
                                <div class="rewind-concept-meta">New • Not reviewed</div>
                            </div>
                            <div class="rewind-concept-score">—</div>
                        </div>
                    </div>
                    
                    <!-- Right: flashcard quiz -->
                    <div class="rewind-panel-right">
                        <div class="rewind-card-counter" id="rewind-card-counter">Question 1 of 3</div>
                        
                        <div class="flashcard" id="flashcard" onclick="flipCard()">
                            <div class="flashcard-label" id="flashcard-label">QUESTION</div>
                            <div class="flashcard-concept" id="flashcard-concept">Brutalist Movement Origins</div>
                            <div class="flashcard-content" id="flashcard-content">
                                What were the key social and economic conditions in post-war Europe that gave rise to Brutalist architecture?
                            </div>
                            <div class="flashcard-hint" id="flashcard-hint">Choose the correct answer</div>
                        </div>
                        
                        <!-- Options mode -->
                        <div class="flashcard-options" id="flashcard-options">
                            <button class="option-btn" onclick="pickOption(0)">
                                <div class="option-label">A</div>
                                <div class="option-text"></div>
                            </button>
                            <button class="option-btn" onclick="pickOption(1)">
                                <div class="option-label">B</div>
                                <div class="option-text"></div>
                            </button>
                            <button class="option-btn" onclick="pickOption(2)">
                                <div class="option-label">C</div>
                                <div class="option-text"></div>
                            </button>
                            <button class="option-btn" onclick="pickOption(3)">
                                <div class="option-label">D</div>
                                <div class="option-text"></div>
                            </button>
                        </div>
                        
                        <div class="see-answer-link hidden" id="see-answer-link" onclick="showFullAnswer()">See full answer ↓</div>
                        
                        <!-- Free recall mode -->
                        <div class="rewind-actions hidden" id="rewind-actions">
                            <button class="rewind-btn again" onclick="rateCard('again')">
                                <div class="rewind-btn-label">Again</div>
                                <div class="rewind-btn-sub">&lt; 1 min</div>
                            </button>
                            <button class="rewind-btn hard" onclick="rateCard('hard')">
                                <div class="rewind-btn-label">Hard</div>
                                <div class="rewind-btn-sub">6 min</div>
                            </button>
                            <button class="rewind-btn good" onclick="rateCard('good')">
                                <div class="rewind-btn-label">Good</div>
                                <div class="rewind-btn-sub">1 day</div>
                            </button>
                            <button class="rewind-btn easy" onclick="rateCard('easy')">
                                <div class="rewind-btn-label">Easy</div>
                                <div class="rewind-btn-sub">4 days</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== DEEP DIVE VIEW ========== -->
            <div class="deepdive-view" id="deepdive-view">
                <div class="deepdive-header">
                    <div class="deepdive-header-left">
                        <button class="deepdive-back" onclick="closeDeepDive()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                        </button>
                        <div>
                            <div class="deepdive-title">Deep Dive</div>
                            <div class="deepdive-subtitle">ARC 424 — Latin American Architecture</div>
                        </div>
                    </div>
                    <div class="deepdive-score-container">
                        <div>
                            <div class="deepdive-score-label">Latency</div>
                        </div>
                        <div class="deepdive-score" id="deepdive-score">
                            <svg class="deepdive-score-ring" viewBox="0 0 36 36">
                                <circle class="deepdive-score-ring-bg" cx="18" cy="18" r="15.5"/>
                                <circle class="deepdive-score-ring-fill" id="deepdive-score-ring" cx="18" cy="18" r="15.5" 
                                    stroke-dasharray="97.4" stroke-dashoffset="48.7"/>
                            </svg>
                            <div class="deepdive-score-value" id="deepdive-score-value">52</div>
                        </div>
                    </div>
                </div>
                
                <div class="deepdive-split">
                    <!-- Left: context -->
                    <div class="deepdive-panel-left">
                        <div class="deepdive-context-section">
                            <div class="deepdive-context-label">Concept</div>
                            <div class="deepdive-concept-name" id="deepdive-concept-name">Brutalist Movement Origins</div>
                        </div>
                        
                        <div class="deepdive-context-section">
                            <div class="deepdive-context-label">What your professor said</div>
                            <div class="deepdive-professor-note" id="deepdive-professor-note">
                                Brutalism wasn't about being brutal — it was about honesty. Raw concrete, exposed structure, no pretense. It came from a post-war world that couldn't afford decoration and didn't want it anyway.
                            </div>
                        </div>
                        
                        <div class="deepdive-context-section">
                            <div class="deepdive-context-label">Related Concepts</div>
                            <div class="deepdive-related">
                                <div class="deepdive-related-item" onclick="switchDeepDiveConcept('Post-War Reconstruction')">
                                    <div class="deepdive-related-dot"></div>
                                    Post-War Reconstruction
                                </div>
                                <div class="deepdive-related-item" onclick="switchDeepDiveConcept('Béton Brut')">
                                    <div class="deepdive-related-dot"></div>
                                    Béton Brut
                                </div>
                                <div class="deepdive-related-item" onclick="switchDeepDiveConcept('Social Housing')">
                                    <div class="deepdive-related-dot"></div>
                                    Social Housing Movement
                                </div>
                            </div>
                        </div>
                        
                        <div class="deepdive-context-section">
                            <div class="deepdive-context-label">Sources</div>
                            <button class="deepdive-source-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                Lecture slides — Jan 28
                            </button>
                            <button class="deepdive-source-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                                Recording — 47:23
                            </button>
                        </div>
                    </div>
                    
                    <!-- Right: conversation -->
                    <div class="deepdive-panel-right">
                        <div class="deepdive-conversation" id="deepdive-conversation">
                            <!-- Messages will be added here dynamically -->
                        </div>
                        
                        <div class="deepdive-input-area">
                            <div class="deepdive-input-container">
                                <textarea class="deepdive-input" id="deepdive-input" placeholder="Type your response..." rows="1" onkeydown="handleDeepDiveKeydown(event)" oninput="autoResizeTextarea(this)"></textarea>
                                <button class="deepdive-send-btn" id="deepdive-send" onclick="sendDeepDiveMessage()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                </button>
                            </div>
                            <button class="deepdive-voice-btn" id="deepdive-voice" onclick="toggleDeepDiveVoice()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                            </button>
                            <button class="deepdive-end-btn" onclick="showScoreReveal()">
                                End Session
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== SYNC VIEW ========== -->
            <div class="sync-view" id="sync-view">
                <div class="sync-header">
                    <div class="sync-header-left">
                        <button class="sync-back" onclick="closeSync()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                        </button>
                        <div>
                            <div class="sync-title">Sync</div>
                            <div class="sync-subtitle">ARC 424 — Latin American Architecture</div>
                        </div>
                    </div>
                    <div class="sync-status" id="sync-status">
                        <div class="sync-status-dot"></div>
                        Ready
                    </div>
                </div>
                
                <div class="sync-split">
                    <!-- Left: Sources Panel -->
                    <div class="sync-panel-left">
                        <div class="sync-sources-header">
                            <span class="sync-sources-title">Sources</span>
                            <span class="sync-sources-count" id="sync-sources-count">0 items</span>
                        </div>
                        
                        <div class="sync-sources-list" id="sync-sources-list">
                            <!-- Uploaded items appear here -->
                        </div>
                        
                        <div class="sync-upload-options">
                            <div class="sync-upload-btn" onclick="document.getElementById('audio-upload').click()">
                                <input type="file" id="audio-upload" accept="audio/*,video/*" style="display:none" onchange="handleAudioUpload(event)">
                                <div class="sync-upload-icon upload">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                </div>
                                <span>Recording</span>
                            </div>
                            
                            <div class="sync-upload-btn" onclick="document.getElementById('slides-upload').click()">
                                <input type="file" id="slides-upload" accept=".pdf,.pptx,.ppt" style="display:none" onchange="handleSlidesUpload(event)">
                                <div class="sync-upload-icon slides">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="3" width="20" height="14" rx="2"/>
                                        <line x1="8" y1="21" x2="16" y2="21"/>
                                        <line x1="12" y1="17" x2="12" y2="21"/>
                                    </svg>
                                </div>
                                <span>Slides</span>
                            </div>
                            
                            <div class="sync-upload-btn" onclick="document.getElementById('notes-upload').click()">
                                <input type="file" id="notes-upload" accept=".pdf,.doc,.docx,.txt" style="display:none" onchange="handleNotesUpload(event)">
                                <div class="sync-upload-icon notes">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                </div>
                                <span>Notes</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Recording Panel -->
                    <div class="sync-panel-right">
                        <!-- Initial State -->
                        <div class="sync-record-prompt" id="sync-record-prompt">
                            <button class="sync-record-btn" onclick="startLiveRecording()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                    <line x1="12" y1="19" x2="12" y2="23"/>
                                </svg>
                            </button>
                            <span class="sync-record-label">Tap to record lecture</span>
                        </div>
                        
                        <!-- Recording State -->
                        <div class="sync-recording-panel hidden" id="sync-recording-panel">
                            <div class="sync-transcript-feed" id="sync-transcript-feed">
                                <!-- Transcript lines fade in here -->
                            </div>
                            
                            <div class="sync-recording-controls">
                                <div class="sync-waveform-container">
                                    <div class="sync-waveform-bars" id="sync-waveform-bars"></div>
                                </div>
                                <div class="sync-timer" id="sync-timer">00:00</div>
                                <button class="sync-stop-btn" onclick="stopRecording()">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Processing State -->
                        <div class="sync-processing-panel hidden" id="sync-processing-panel">
                            <div class="sync-processing-content">
                                <div class="processing-spinner large"></div>
                                <span class="sync-processing-title">Processing...</span>
                                <span class="sync-processing-desc" id="sync-processing-desc">Transcribing audio</span>
                                <div class="sync-processing-progress">
                                    <div class="sync-progress-bar" id="sync-progress-bar"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Complete State -->
                        <div class="sync-complete-panel hidden" id="sync-complete-panel">
                            <div class="sync-complete-content">
                                <div class="sync-complete-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                </div>
                                <span class="sync-complete-title">Sync Complete</span>
                                <span class="sync-complete-desc">4 new concepts extracted</span>
                                <div class="sync-complete-concepts">
                                    <div class="sync-concept-tag">Brutalist Origins</div>
                                    <div class="sync-concept-tag">Béton Brut</div>
                                    <div class="sync-concept-tag">Social Housing</div>
                                    <div class="sync-concept-tag">Post-War Context</div>
                                </div>
                                <button class="sync-done-btn" onclick="closeSync()">Done</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div class="app-container" id="studio-app">
        <div class="studio-layout">
            <div class="studio-sidebar" id="studio-sidebar">
                <div class="sidebar-header">
                    <button class="back-btn" onclick="exitApp()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                    </button>
                    <span class="sidebar-logo">STUDIO</span>
                    <span class="header-badge">Beta</span>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Workspace</div>
                    <div class="sidebar-item active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                        Canvas
                    </div>
                    <div class="sidebar-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                        Recordings
                    </div>
                </div>
                <div class="sidebar-section-title" style="padding: 12px 20px 8px;">Projects</div>
                <div class="project-list">
                    <div class="project-item active">
                        <div class="project-thumb">🏛️</div>
                        <div class="project-info">
                            <div class="project-name">Museum Concept</div>
                            <div class="project-date">Today</div>
                        </div>
                    </div>
                    <div class="project-item">
                        <div class="project-thumb">🏠</div>
                        <div class="project-info">
                            <div class="project-name">Residential Tower</div>
                            <div class="project-date">Yesterday</div>
                        </div>
                    </div>
                    <div class="project-item">
                        <div class="project-thumb">🌿</div>
                        <div class="project-info">
                            <div class="project-name">Eco Pavilion</div>
                            <div class="project-date">Jan 28</div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button class="btn-new">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        New Project
                    </button>
                </div>
            </div>
            
            <div class="studio-main">
                <div class="studio-header">
                    <button class="toggle-btn" onclick="toggleStudioSidebar()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                    <span class="studio-header-center">Museum Concept</span>
                    <div class="studio-header-right">
                        <button class="toggle-btn" title="Undo">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                        </button>
                        <button class="toggle-btn" title="Export">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                        <div class="avatar">DJ</div>
                    </div>
                </div>
                
                <div class="studio-canvas" id="studio-canvas">
                    <div class="canvas-grid"></div>
                    
                    <!-- Edit Tools -->
                    <div class="edit-tools">
                        <button class="edit-tool-btn" id="box-tool" onclick="toggleBoxMode()" title="Add edit box">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                        </button>
                        <button class="edit-tool-btn" id="sketch-tool" onclick="toggleSketchMode()" title="Sketch mode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg>
                        </button>
                        <button class="edit-tool-btn" id="camera-tool" onclick="toggleCameraMode()" title="Camera OCR">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        </button>
                        <button class="edit-tool-btn" id="upload-tool" onclick="triggerUpload()" title="Upload image">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        </button>
                    </div>
                    <input type="file" id="upload-input" accept="image/*" style="display:none;" onchange="handleUpload(event)"/>
                    
                    <!-- Text Input Toggle -->
                    <button class="text-input-toggle" onclick="toggleTextInput()" title="Type instead">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>
                    </button>
                    
                    <!-- Empty State -->
                    <div class="empty-state" id="empty-state">
                        <div class="empty-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
                        </div>
                        <h3 class="empty-title">Start talking</h3>
                        <p class="empty-desc">Click the waveform to describe your design. Upload sketches, generate floor plans, create renders.</p>
                    </div>
                    
                    <!-- Dialogue Area - Bottom section -->
                    <div class="dialogue-area">
                        <!-- Generations Carousel -->
                        <div class="generations-carousel">
                            <div class="generation-item active">v1</div>
                            <div class="generation-item">v2</div>
                            <div class="generation-item">v3</div>
                            <div class="generation-item add-new">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </div>
                        </div>
                        
                        <!-- Dialogue Box -->
                        <div class="dialogue-box" id="dialogue-box">
                            <div class="dialogue-label">You</div>
                            <div class="dialogue-text empty" id="dialogue-text">Click the waveform below to start speaking...</div>
                        </div>
                        
                        <!-- Recording Indicator -->
                        <div class="recording-indicator" id="recording-indicator">
                            <div class="recording-dot"></div>
                            <span>Listening...</span>
                        </div>
                        
                        <!-- Waveform -->
                        <div class="waveform-container" id="waveform" onclick="toggleRecording()">
                            <div class="waveform-bar" id="waveform-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shell -->
    <div class="app-container" id="shell-app">
        <header class="app-header">
            <div class="header-left">
                <button class="back-btn" onclick="exitApp()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                </button>
                <div class="header-logo">
                    <span class="header-logo-text">SHELL</span>
                    <span class="header-badge">Coming Soon</span>
                </div>
            </div>
            <div class="header-right">
                <div class="avatar">DJ</div>
            </div>
        </header>
        <main class="app-main">
            <div class="placeholder-screen">
                <h2>SHELL is coming soon</h2>
                <p>Build, debug, and document your code journey.</p>
            </div>
        </main>
    </div>
    
    <!-- Flow -->
    <div class="app-container" id="flow-app">
        <header class="app-header">
            <div class="header-left">
                <button class="back-btn" onclick="exitApp()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                </button>
                <div class="header-logo">
                    <span class="header-logo-text">FLOW</span>
                    <span class="header-badge">Coming Soon</span>
                </div>
            </div>
            <div class="header-right">
                <div class="avatar">DJ</div>
            </div>
        </header>
        <main class="app-main">
            <div class="placeholder-screen">
                <h2>FLOW is coming soon</h2>
                <p>Automate the repetitive tasks in your workflow.</p>
            </div>
        </main>
    </div>
    
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    </button>
    
    <script>
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, centerY;
        let particles = [];
        let logoPoints = [];
        let currentPhase = 'float';
        let phaseStart = 0;
        let isDarkMode = false;
        let userType = 'returning'; // Always returning — wizard handles new users
        let currentFrame = 1;
        let courses = [];
        let isRecording = false;
        let waveformLines = [];
        let boxMode = false;
        let sketchMode = false;
        let boxColors = ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];
        let boxColorIndex = 0;
        const logoScale = 1.4;
        
        const sampleCourses = [
            { prefix: 'ARC', number: '418', name: 'Latin American Architecture', progress: 72, sessions: 12 },
            { prefix: 'ARC', number: '342', name: 'Construction Methods', progress: 58, sessions: 8 },
            { prefix: 'POL', number: '241', name: 'Political Science', progress: 85, sessions: 15 },
            { prefix: 'ARC', number: '401', name: 'Studio V', progress: 45, sessions: 6 }
        ];
        
        function toggleTheme() {
            toggleDarkMode();
        }
        
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            
            // Update settings toggle
            const toggle = document.getElementById('theme-toggle-settings');
            const label = document.getElementById('theme-label-settings');
            if (toggle) {
                toggle.classList.toggle('active', isDarkMode);
            }
            if (label) {
                label.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
            }
        }
        
        function toggleSettings() {
            const dropdown = document.getElementById('settings-dropdown');
            dropdown.classList.toggle('visible');
        }
        
        // Close settings when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('settings-dropdown');
            const container = e.target.closest('.settings-container');
            if (!container && dropdown && dropdown.classList.contains('visible')) {
                dropdown.classList.remove('visible');
            }
        });
        
        function getParticleColor() {
            return isDarkMode ? '245, 245, 247' : '29, 29, 31';
        }
        
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
            generateLogoPoints();
            initWaveform();
        }
        
        function generateLogoPoints() {
            logoPoints = [];
            for (let y = -45; y <= 45; y += 4) {
                for (let x = -50; x <= -38; x += 5) {
                    logoPoints.push({ x: x * logoScale, y: y * logoScale });
                }
            }
            for (let x = -50; x <= -10; x += 5) {
                for (let y = 33; y <= 45; y += 5) {
                    logoPoints.push({ x: x * logoScale, y: y * logoScale });
                }
            }
            for (let t = 0; t <= 1; t += 0.035) {
                const x = -10 + t * 55;
                const y = 35 - t * 75;
                logoPoints.push({ x: x * logoScale, y: y * logoScale });
                logoPoints.push({ x: (x + 2) * logoScale, y: (y - 2) * logoScale });
            }
            const cx = 45, cy = -40, r = 14;
            for (let ri = 0; ri <= r; ri += 4) {
                const c = Math.max(1, Math.floor(2 * Math.PI * ri / 5));
                for (let i = 0; i < c; i++) {
                    const a = (i / c) * Math.PI * 2;
                    logoPoints.push({ x: (cx + Math.cos(a) * ri) * logoScale, y: (cy + Math.sin(a) * ri) * logoScale });
                }
            }
        }
        
        class Particle {
            constructor(isLogo = false, idx = 0) {
                this.isLogo = isLogo;
                this.idx = idx;
                this.char = Math.random() > 0.5 ? '1' : '0';
                this.size = 9 + Math.random() * 2;
                this.reset();
            }
            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = (Math.random() - 0.5) * 4;
                this.baseOp = 0.2 + Math.random() * 0.2;
                this.opacity = this.baseOp;
                this.offset = Math.random() * 1000;
                this.speed = 0.8 + Math.random() * 0.8;
                this.exploded = false;
            }
            noise(t) { return Math.sin(t * 1.3) * 0.5 + Math.sin(t * 2.7) * 0.3 + Math.sin(t * 4.1) * 0.2; }
            ease(t) { return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2; }
            update(phase, prog, time) {
                const t = time * 0.001 + this.offset;
                if (phase === 'float') {
                    this.vx += this.noise(t * this.speed) * 0.04;
                    this.vy += this.noise(t * this.speed + 100) * 0.04;
                    const sp = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                    if (sp > 2.5) { this.vx = (this.vx / sp) * 2.5; this.vy = (this.vy / sp) * 2.5; }
                    this.vx *= 0.992; this.vy *= 0.992;
                    this.x += this.vx; this.y += this.vy;
                    this.wrap();
                    this.opacity = this.baseOp;
                } else if (phase === 'converge') {
                    if (this.isLogo && this.idx < logoPoints.length) {
                        const tgt = logoPoints[this.idx];
                        const dx = centerX + tgt.x - this.x, dy = centerY + tgt.y - this.y;
                        const d = Math.sqrt(dx * dx + dy * dy);
                        const pull = 0.015 + this.ease(prog) * 0.2;
                        this.vx += dx * pull; this.vy += dy * pull;
                        this.vx *= d < 30 ? 0.8 : 0.9; this.vy *= d < 30 ? 0.8 : 0.9;
                        this.x += this.vx; this.y += this.vy;
                        this.opacity = d < 15 ? 0.7 + (1 - d / 15) * 0.3 : this.baseOp + this.ease(prog) * 0.4;
                    } else {
                        this.x += this.vx * 0.3; this.y += this.vy * 0.3;
                        this.opacity = this.baseOp * (1 - prog * 0.8);
                    }
                } else if (phase === 'logo') {
                    if (this.isLogo && this.idx < logoPoints.length) {
                        const tgt = logoPoints[this.idx];
                        const b = Math.sin(t * 1.5) * 0.8;
                        this.x = centerX + tgt.x + b * Math.cos(this.offset);
                        this.y = centerY + tgt.y + b * Math.sin(this.offset);
                        this.opacity = 1;
                    } else {
                        this.x += this.vx * 0.15; this.y += this.vy * 0.15;
                        this.wrap();
                        this.opacity = 0.04;
                    }
                } else if (phase === 'explode') {
                    if (this.isLogo) {
                        if (!this.exploded) {
                            this.expAngle = Math.atan2(this.y - centerY, this.x - centerX) + (Math.random() - 0.5) * 0.6;
                            this.expSpeed = 18 + Math.random() * 25;
                            this.exploded = true;
                        }
                        const eo = 1 - Math.pow(1 - prog, 2);
                        this.x += Math.cos(this.expAngle) * this.expSpeed * (1 - eo * 0.7);
                        this.y += Math.sin(this.expAngle) * this.expSpeed * (1 - eo * 0.7) + prog * 2;
                        this.opacity = 1 - prog * prog;
                    } else {
                        this.x += this.vx * 0.2; this.y += this.vy * 0.2;
                        this.opacity = 0.04;
                    }
                } else if (phase === 'settle') {
                    this.vx += this.noise(t * 0.4) * 0.008;
                    this.vy += this.noise(t * 0.4 + 100) * 0.008;
                    this.vx *= 0.995; this.vy *= 0.995;
                    this.x += this.vx; this.y += this.vy;
                    this.wrap();
                    this.opacity = 0.06 + this.noise(t) * 0.03;
                }
            }
            wrap() {
                if (this.x < -30) this.x = width + 30;
                if (this.x > width + 30) this.x = -30;
                if (this.y < -30) this.y = height + 30;
                if (this.y > height + 30) this.y = -30;
            }
            draw() {
                if (this.opacity <= 0) return;
                ctx.font = `500 ${this.size}px "SF Mono", Monaco, monospace`;
                ctx.fillStyle = `rgba(${getParticleColor()}, ${Math.min(1, this.opacity)})`;
                ctx.fillText(this.char, this.x, this.y);
            }
        }
        
        function initParticles() {
            particles = [];
            for (let i = 0; i < 50; i++) particles.push(new Particle(false, 0));
            for (let i = 0; i < logoPoints.length; i++) particles.push(new Particle(true, i));
        }
        
        function animate(time) {
            ctx.clearRect(0, 0, width, height);
            const elapsed = time - phaseStart;
            const durations = { float: 2000, converge: 2000, logo: 1500, explode: 900, settle: Infinity };
            const prog = Math.min(elapsed / (durations[currentPhase] || 2000), 1);
            particles.forEach(p => { p.update(currentPhase, prog, time); p.draw(); });
            requestAnimationFrame(animate);
        }
        
        function setPhase(phase) {
            currentPhase = phase;
            phaseStart = performance.now();
            if (phase === 'explode') particles.forEach(p => p.exploded = false);
            if (phase === 'settle') particles.forEach(p => {
                p.vx = (Math.random() - 0.5) * 0.8;
                p.vy = (Math.random() - 0.5) * 0.8;
                p.exploded = false;
                if (p.isLogo) { p.x = Math.random() * width; p.y = Math.random() * height; }
            });
        }
        
        function hideAll() {
            ['welcome-screen', 'tools-screen'].forEach(id => document.getElementById(id).classList.remove('visible'));
        }
        
        function updateDots(frame) {
            currentFrame = frame;
        }
        
        function jumpToFrame(frame) {
            hideAll();
            updateDots(frame);
            switch (frame) {
                case 1: initParticles(); setPhase('float'); break;
                case 2: setPhase('converge'); break;
                case 3: setPhase('logo'); break;
                case 4: setPhase('explode'); break;
                case 5:
                    setPhase('settle');
                    document.getElementById('welcome-screen').classList.add('visible');
                    setTimeout(() => {
                        if (currentFrame === 5) {
                            hideAll();
                            setTimeout(() => jumpToFrame(6), 400);
                        }
                    }, 2000);
                    break;
                case 6:
                    setPhase('settle');
                    document.getElementById('tools-screen').classList.add('visible');
                    break;
            }
        }
        
        function playAnimation() {
            ['academy-app', 'studio-app', 'shell-app', 'flow-app'].forEach(id => document.getElementById(id).classList.remove('visible'));
            skipToDashboard();
        }
        
        
        
        function skipToDashboard() {
            hideAll();
            
            document.getElementById('welcome-screen').classList.add('visible');
            
            setTimeout(() => {
                document.getElementById('welcome-screen').classList.remove('visible');
                setTimeout(() => {
                    document.getElementById('tools-screen').classList.add('visible');
                    updateDots(6);
                    currentFrame = 6;
                }, 300);
            }, 1500);
        }
        
        // Auth handled by wizard — no longer needed here
        
        function openApp(app) {
            document.getElementById('tools-screen').classList.remove('visible');
            
            setTimeout(() => {
                document.getElementById(app + '-app').classList.add('visible');
                if (app === 'academy') updateAcademyView();
                if (app === 'studio') initWaveform();
            }, 300);
        }
        
        function exitApp() {
            // Reset ALL states completely before going back to tools
            resetAllViews();
            ['academy-app', 'studio-app', 'shell-app', 'flow-app'].forEach(id => document.getElementById(id).classList.remove('visible'));
            
            setTimeout(() => document.getElementById('tools-screen').classList.add('visible'), 300);
        }
        
        // Central state reset — ensures only one view is ever showing
        function resetAllViews() {
            document.getElementById('analytics-view').classList.remove('visible');
            document.getElementById('course-detail-view').classList.remove('visible');
            document.getElementById('rewind-view').classList.remove('visible');
            document.getElementById('sync-view').classList.remove('visible');
            document.getElementById('deepdive-view').classList.remove('visible');
            document.getElementById('academy-new').style.display = 'none';
            document.getElementById('academy-dashboard').style.display = 'none';
        }
        
        function updateAcademyView() {
            resetAllViews();
            if (userType === 'new') {
                document.getElementById('academy-new').style.display = 'flex';
            } else {
                document.getElementById('academy-dashboard').style.display = 'flex';
                renderDashboard();
            }
        }
        
        function removeCourse(i) { courses.splice(i, 1); renderCourses(); }
        
        function renderCourses() {
            const area = document.getElementById('course-tags');
            const count = document.getElementById('course-count');
            const btn = document.getElementById('btn-continue');
            area.innerHTML = courses.map((c, i) => `
                <div class="tag">
                    <strong>${c.prefix} ${c.number}</strong>${c.name ? ` — ${c.name}` : ''}
                    <button class="tag-remove" onclick="removeCourse(${i})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
            `).join('');
            area.classList.toggle('has-items', courses.length > 0);
            count.textContent = `${courses.length} course${courses.length !== 1 ? 's' : ''}`;
            btn.classList.toggle('active', courses.length > 0);
        }
        
        function finishOnboarding() {
            if (courses.length > 0) {
                courses.forEach(c => sampleCourses.unshift({ ...c, progress: 0, sessions: 0 }));
                updateAcademyView();
            }
        }
        
        function renderDashboard() {
            const grid = document.getElementById('courses-grid');
            grid.innerHTML = sampleCourses.map(c => {
                const displayName = c.name || `${c.prefix} ${c.number}`;
                return `
                <div class="course-card" onclick="openCourseDetail('${c.prefix} ${c.number}', '${displayName}')" style="cursor:pointer;">
                    <div class="course-card-code">${c.prefix} ${c.number}</div>
                    <div class="course-card-name">${displayName}</div>
                    <div class="course-card-progress"><div class="course-card-bar" style="width:${c.progress}%"></div></div>
                    <div class="course-card-stats"><span>${c.progress}% mastered</span><span>${c.sessions} sessions</span></div>
                </div>
            `}).join('') + `
                <div class="add-card" onclick="alert('Connect more courses in Settings → Canvas')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span>Add Course</span>
                </div>
            `;
        }
        
        function toggleTodayBar() {
            document.getElementById('today-bar').classList.toggle('expanded');
        }
        
        function openAnalytics() {
            resetAllViews();
            document.getElementById('analytics-view').classList.add('visible');
        }
        
        function closeAnalytics() {
            resetAllViews();
            if (userType === 'returning') {
                document.getElementById('academy-dashboard').style.display = 'flex';
            } else {
                document.getElementById('academy-new').style.display = 'flex';
            }
        }
        
        function openCourseDetail(code, name) {
            resetAllViews();
            document.getElementById('detail-course-name').textContent = name;
            document.getElementById('course-detail-view').classList.add('visible');
        }
        
        function closeCourseDetail() {
            resetAllViews();
            document.getElementById('academy-dashboard').style.display = 'flex';
        }
        
        function startSync() {
            document.getElementById('sync-view').classList.add('visible');
            document.getElementById('course-detail-view').classList.remove('visible');
            // Reset to initial state
            document.getElementById('sync-record-prompt').classList.remove('hidden');
            document.getElementById('sync-recording-panel').classList.add('hidden');
            document.getElementById('sync-processing-panel').classList.add('hidden');
            document.getElementById('sync-complete-panel').classList.add('hidden');
            document.getElementById('sync-status').classList.remove('recording');
            document.getElementById('sync-status').innerHTML = '<div class="sync-status-dot"></div>Ready';
            document.getElementById('sync-sources-list').innerHTML = '';
            updateSourcesCount();
        }
        
        function closeSync() {
            document.getElementById('sync-view').classList.remove('visible');
            document.getElementById('course-detail-view').classList.add('visible');
            clearInterval(syncTimer);
        }
        
        let syncTimer = null;
        let syncSeconds = 0;
        let transcriptLines = [];
        
        function startLiveRecording() {
            // Show recording panel
            document.getElementById('sync-record-prompt').classList.add('hidden');
            document.getElementById('sync-recording-panel').classList.remove('hidden');
            document.getElementById('sync-status').classList.add('recording');
            document.getElementById('sync-status').innerHTML = '<div class="sync-status-dot"></div>Recording';
            
            // Clear transcript feed
            document.getElementById('sync-transcript-feed').innerHTML = '';
            transcriptLines = [];
            
            // Initialize waveform bars
            const barsContainer = document.getElementById('sync-waveform-bars');
            barsContainer.innerHTML = '';
            for (let i = 0; i < 60; i++) {
                const bar = document.createElement('div');
                bar.className = 'sync-waveform-bar';
                bar.style.height = '4px';
                barsContainer.appendChild(bar);
            }
            
            // Start timer
            syncSeconds = 0;
            document.getElementById('sync-timer').textContent = '00:00';
            syncTimer = setInterval(() => {
                syncSeconds++;
                const mins = Math.floor(syncSeconds / 60).toString().padStart(2, '0');
                const secs = (syncSeconds % 60).toString().padStart(2, '0');
                document.getElementById('sync-timer').textContent = `${mins}:${secs}`;
            }, 1000);
            
            // Animate waveform
            animateSyncWaveform();
            
            // Simulate live transcript with fade-in lines
            simulateTranscriptFeed();
        }
        
        function animateSyncWaveform() {
            const recordingPanel = document.getElementById('sync-recording-panel');
            if (recordingPanel && !recordingPanel.classList.contains('hidden')) {
                const bars = document.querySelectorAll('.sync-waveform-bar');
                bars.forEach((bar, i) => {
                    const height = 4 + Math.random() * 40;
                    bar.style.height = height + 'px';
                });
                requestAnimationFrame(() => setTimeout(animateSyncWaveform, 100));
            }
        }
        
        function simulateTranscriptFeed() {
            const transcripts = [
                "So today we're going to talk about the origins of Brutalism...",
                "The term actually comes from the French 'béton brut'...",
                "Which translates to raw concrete.",
                "Post-war Europe faced a massive housing crisis.",
                "Millions of people needed homes, and there was very little money.",
                "Architects like Alison and Peter Smithson saw an opportunity.",
                "They wanted to create honest architecture.",
                "No pretense. No decoration hiding the structure.",
                "The concrete was the building. Nothing more, nothing less.",
                "This was a radical departure from what came before.",
            ];
            
            let idx = 0;
            const feedContainer = document.getElementById('sync-transcript-feed');
            
            const interval = setInterval(() => {
                const recordingPanel = document.getElementById('sync-recording-panel');
                if (!recordingPanel || recordingPanel.classList.contains('hidden')) {
                    clearInterval(interval);
                    return;
                }
                
                // Add new line with fade-in animation
                const line = document.createElement('div');
                line.className = 'sync-transcript-line';
                line.textContent = transcripts[idx];
                feedContainer.appendChild(line);
                
                // Fade older lines
                const allLines = feedContainer.querySelectorAll('.sync-transcript-line');
                allLines.forEach((l, i) => {
                    if (i < allLines.length - 3) {
                        l.classList.add('fading');
                    }
                });
                
                // Auto-scroll
                feedContainer.scrollTop = feedContainer.scrollHeight;
                
                idx = (idx + 1) % transcripts.length;
            }, 2500);
        }
        
        function stopRecording() {
            clearInterval(syncTimer);
            
            // Show processing
            document.getElementById('sync-recording-panel').classList.add('hidden');
            document.getElementById('sync-processing-panel').classList.remove('hidden');
            document.getElementById('sync-status').classList.remove('recording');
            document.getElementById('sync-status').innerHTML = '<div class="sync-status-dot"></div>Processing';
            
            // Simulate processing steps
            const steps = [
                { text: 'Transcribing audio', progress: 30 },
                { text: 'Extracting concepts', progress: 60 },
                { text: 'Generating flashcards', progress: 85 },
                { text: 'Finalizing', progress: 100 }
            ];
            
            let stepIdx = 0;
            const processInterval = setInterval(() => {
                if (stepIdx < steps.length) {
                    document.getElementById('sync-processing-desc').textContent = steps[stepIdx].text;
                    document.getElementById('sync-progress-bar').style.width = steps[stepIdx].progress + '%';
                    stepIdx++;
                } else {
                    clearInterval(processInterval);
                    setTimeout(() => {
                        document.getElementById('sync-processing-panel').classList.add('hidden');
                        document.getElementById('sync-complete-panel').classList.remove('hidden');
                        document.getElementById('sync-status').innerHTML = '<div class="sync-status-dot" style="background:#28c840"></div>Complete';
                    }, 500);
                }
            }, 800);
        }
        
        function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (file) {
                addSourceItem('audio', file.name, formatFileSize(file.size));
                event.target.value = '';
            }
        }
        
        function handleSlidesUpload(event) {
            const file = event.target.files[0];
            if (file) {
                addSourceItem('slides', file.name, formatFileSize(file.size));
                event.target.value = '';
            }
        }
        
        function handleNotesUpload(event) {
            const file = event.target.files[0];
            if (file) {
                addSourceItem('notes', file.name, formatFileSize(file.size));
                event.target.value = '';
            }
        }
        
        function addSourceItem(type, name, size) {
            const list = document.getElementById('sync-sources-list');
            const icons = {
                audio: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',
                slides: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
                notes: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>'
            };
            
            const item = document.createElement('div');
            item.className = 'sync-source-item';
            item.innerHTML = `
                <div class="sync-source-icon ${type}">${icons[type]}</div>
                <div class="sync-source-info">
                    <div class="sync-source-name">${name}</div>
                    <div class="sync-source-meta">${size}</div>
                </div>
            `;
            list.appendChild(item);
            updateSourcesCount();
        }
        
        function updateSourcesCount() {
            const count = document.querySelectorAll('.sync-source-item').length;
            document.getElementById('sync-sources-count').textContent = `${count} item${count !== 1 ? 's' : ''}`;
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function simulateProcessing(initialText) {
            document.getElementById('sync-record-prompt').classList.add('hidden');
            document.getElementById('sync-processing-panel').classList.remove('hidden');
            document.getElementById('sync-processing-desc').textContent = initialText;
            document.getElementById('sync-progress-bar').style.width = '0%';
            
            const steps = [
                { text: initialText, progress: 20 },
                { text: 'Extracting key concepts', progress: 50 },
                { text: 'Generating study materials', progress: 80 },
                { text: 'Finalizing', progress: 100 }
            ];
            
            let stepIdx = 0;
            const processInterval = setInterval(() => {
                if (stepIdx < steps.length) {
                    document.getElementById('sync-processing-desc').textContent = steps[stepIdx].text;
                    document.getElementById('sync-progress-bar').style.width = steps[stepIdx].progress + '%';
                    stepIdx++;
                } else {
                    clearInterval(processInterval);
                    setTimeout(() => {
                        document.getElementById('sync-processing-panel').classList.add('hidden');
                        document.getElementById('sync-complete-panel').classList.remove('hidden');
                        document.getElementById('sync-status').innerHTML = '<div class="sync-status-dot" style="background:#28c840"></div>Complete';
                    }, 500);
                }
            }, 800);
        }
        
        // Syllabus upload handlers
        function handleSyllabusUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Show processing
                document.getElementById('syllabus-upload').classList.add('hidden');
                document.getElementById('syllabus-processing').classList.remove('hidden');
                
                // Simulate processing
                setTimeout(() => {
                    // Extract course info (simulated)
                    const courseName = file.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ');
                    
                    // Add course with extracted name
                    courses.push({ 
                        prefix: 'NEW', 
                        number: String(Math.floor(Math.random() * 400) + 100), 
                        name: courseName 
                    });
                    renderCourses();
                    
                    // Reset upload area
                    document.getElementById('syllabus-processing').classList.add('hidden');
                    document.getElementById('syllabus-upload').classList.remove('hidden');
                }, 2000);
            }
        }
        
        function addCourseManual() {
            const prefix = document.getElementById('c-prefix').value.trim().toUpperCase();
            const number = document.getElementById('c-number').value.trim();
            if (prefix && number) {
                const id = `${prefix} ${number}`;
                if (!courses.find(c => `${c.prefix} ${c.number}` === id)) {
                    courses.push({ prefix, number, name: `${prefix} ${number} Course` });
                    renderCourses();
                    document.getElementById('c-prefix').value = '';
                    document.getElementById('c-number').value = '';
                    document.getElementById('c-prefix').focus();
                }
            }
        }
        
        // Drag and drop for syllabus
        const syllabusUpload = document.getElementById('syllabus-upload');
        if (syllabusUpload) {
            syllabusUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                syllabusUpload.classList.add('dragover');
            });
            
            syllabusUpload.addEventListener('dragleave', () => {
                syllabusUpload.classList.remove('dragover');
            });
            
            syllabusUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                syllabusUpload.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    // Trigger the same handler
                    const input = document.getElementById('syllabus-input');
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    input.files = dt.files;
                    handleSyllabusUpload({ target: input });
                }
            });
        }
        
        function openRewind() {
            document.getElementById('rewind-view').classList.add('visible');
            document.getElementById('course-detail-view').classList.remove('visible');
            rewindState.activeConcept = 0;
            rewindState.questionIndex = 0;
            rewindState.flipped = false;
            rewindState.answered = false;
            updateConceptList();
            loadQuestion();
        }
        
        function closeRewind() {
            document.getElementById('rewind-view').classList.remove('visible');
            document.getElementById('course-detail-view').classList.add('visible');
        }
        
        const rewindState = {
            activeConcept: 0,
            questionIndex: 0,
            flipped: false,
            answered: false,
            mode: 'options',
            concepts: [
                {
                    name: 'Brutalist Movement Origins', score: 32, priority: 'urgent',
                    questions: [
                        {
                            q: 'What were the key social and economic conditions in post-war Europe that gave rise to Brutalist architecture?',
                            a: 'Post-WWII Europe faced massive housing shortages and limited budgets. Brutalism emerged from the need for rapid, affordable construction using raw concrete (béton brut), rejecting decorative excess for honest material expression.',
                            options: ['Rise of Art Deco luxury materials in commercial architecture', 'Post-war housing shortages driving raw, honest concrete construction', 'Colonial expansion creating demand for European styles abroad', 'Digital revolution enabling parametric design'],
                            correct: 1
                        },
                        {
                            q: 'What does "béton brut" literally mean, and how does it relate to the movement\'s name?',
                            a: 'Béton brut is French for "raw concrete." The term Brutalism derives directly from this — it\'s about the honest, unfinished expression of concrete as both structure and surface, not about being "brutal" in the colloquial sense.',
                            options: ['\"Beautiful structure\" — celebrating elegant engineering', '\"Raw concrete\" — honest expression of unfinished material', '\"Broken tradition\" — rejecting all historical precedent', '\"Bold rhythm\" — emphasizing repetitive modular patterns'],
                            correct: 1
                        },
                        {
                            q: 'Name two seminal Brutalist buildings and their architects.',
                            a: 'Le Corbusier\'s Unité d\'Habitation in Marseille (1952) and the Smithsons\' Robin Hood Gardens in London (1972) are key examples. Both used raw concrete at massive scale for social housing.',
                            options: ['Villa Savoie (Mies) and Fallingwater (Wright)', 'Unité d\'Habitation (Le Corbusier) and Robin Hood Gardens (Smithsons)', 'Crystal Palace (Paxton) and Sagrada Familia (Gaudi)', 'Guggenheim Bilbao (Gehry) and Sydney Opera House (Utzon)'],
                            correct: 1
                        }
                    ]
                },
                {
                    name: 'Tropical Architecture', score: 65, priority: 'urgent',
                    questions: [
                        {
                            q: 'How does tropical architecture respond to climate differently than modernist universal design?',
                            a: 'It rejects sealed, climate-controlled boxes in favor of cross-ventilation, deep overhangs, raised floors, permeable walls, and local materials — working with climate rather than against it.',
                            options: ['Thicker insulation and smaller windows to block heat', 'Importing European materials that resist humidity', 'Cross-ventilation, deep overhangs, raised floors, and permeable walls', 'Sealing buildings and relying on mechanical AC'],
                            correct: 2
                        },
                        {
                            q: 'Which architect is considered the father of tropical modernism in Sri Lanka?',
                            a: 'Geoffrey Bawa pioneered tropical modernism in Sri Lanka, blending modernist spatial principles with open-air living, courtyards, and lush landscape integration.',
                            options: ['Tadao Ando', 'Geoffrey Bawa', 'Oscar Niemeyer', 'Rem Koolhaas'],
                            correct: 1
                        },
                        {
                            q: 'What role does the courtyard play in tropical architecture?',
                            a: 'The courtyard creates a microclimate — shaded outdoor space that draws hot air up through stack ventilation, channels breezes through surrounding rooms, and brings diffused light deep into the plan without direct solar gain.',
                            options: ['Purely decorative — a visual focal point with no thermal function', 'Creates a microclimate using stack ventilation, shading, and breeze channeling', 'Used exclusively for rainwater collection and storage', 'Functions as a firebreak between building wings'],
                            correct: 1
                        }
                    ]
                },
                {
                    name: 'Mexican Modernism', score: 80, priority: 'due',
                    questions: [
                        {
                            q: 'What distinguishes Mexican Modernism from the International Style?',
                            a: 'It fused International Style principles with pre-Columbian heritage, muralism, and local craftsmanship. Unlike the International Style\'s universality, Mexican Modernism insisted on regional identity.',
                            options: ['Strictly followed Le Corbusier\'s five points without adaptation', 'Fused International Style with pre-Columbian heritage and regional identity', 'Focused exclusively on imported industrial materials', 'Rejected all modernist principles for indigenous methods'],
                            correct: 1
                        },
                        {
                            q: 'What type of structures was Félix Candela known for?',
                            a: 'Candela pioneered thin-shell concrete hyperbolic paraboloid structures — roofs that span large distances using minimal material through geometric efficiency rather than mass.',
                            options: ['Massive stone pyramid restorations', 'Thin-shell concrete hyperbolic paraboloid structures', 'Prefabricated steel residential towers', 'Adobe and rammed earth community buildings'],
                            correct: 1
                        },
                        {
                            q: 'How did Juan O\'Gorman bridge functionalism and Mexican identity?',
                            a: 'O\'Gorman designed rigorously functional buildings but covered them in mosaic murals depicting Mexican history and culture — most famously the UNAM Central Library, where the entire facade is a mural.',
                            options: ['He built exact replicas of European modernist buildings in Mexico City', 'He combined functional buildings with mosaic murals of Mexican history', 'He rejected modernism entirely and built only traditional haciendas', 'He focused on landscape design rather than architecture'],
                            correct: 1
                        }
                    ]
                },
                {
                    name: 'Post-Revolution Muralism', score: 58, priority: 'due',
                    questions: [
                        {
                            q: 'How did muralism become connected to architecture after the Mexican Revolution?',
                            a: 'After 1910, muralism became state policy for public education. Rivera, Orozco, and Siqueiros treated architecture as canvas — murals shaped spatial experience, dissolving the boundary between art and building.',
                            options: ['Murals were kept in frames on gallery walls, separate from buildings', 'Architecture became the canvas — murals shaped spatial experience', 'Muralists rejected architecture and worked only on portable canvases', 'Buildings were painted white to contrast with interior murals'],
                            correct: 1
                        },
                        {
                            q: 'Name the three most prominent Mexican muralists.',
                            a: 'Diego Rivera, José Clemente Orozco, and David Alfaro Siqueiros — collectively known as "Los Tres Grandes" (The Three Greats). Each had distinct styles but shared the mission of public, politically engaged art.',
                            options: ['Frida Kahlo, Rufino Tamayo, and Leonora Carrington', 'Diego Rivera, José Clemente Orozco, and David Alfaro Siqueiros', 'Luis Barragán, Juan O\'Gorman, and Félix Candela', 'Pablo Picasso, Joan Miró, and Salvador Dalí'],
                            correct: 1
                        },
                        {
                            q: 'What building best exemplifies the fusion of muralism and architecture?',
                            a: 'UNAM\'s Central Library by Juan O\'Gorman — the entire facade is covered in mosaic murals depicting pre-Hispanic and colonial Mexican history. The building IS the mural; architecture and art are inseparable.',
                            options: ['The Palacio de Bellas Artes concert hall', 'UNAM Central Library by Juan O\'Gorman', 'The National Palace presidential residence', 'Chapultepec Castle museum'],
                            correct: 1
                        }
                    ]
                },
                {
                    name: 'Barragán\'s Color Theory', score: 94, priority: 'fresh',
                    questions: [
                        {
                            q: 'How did Barragán use color as a spatial element rather than decoration?',
                            a: 'Barragán treated color as architecture itself — his pinks, yellows, and purples create emotional atmospheres, alter perceived scale, and direct movement. Color walls define space without enclosure.',
                            options: ['Thin accent stripes on otherwise white surfaces', 'Only primary colors following Mondrian\'s De Stijl', 'Color defined space — creating atmosphere, altering scale, directing movement', 'He avoided color, focusing on raw concrete and natural materials'],
                            correct: 2
                        },
                        {
                            q: 'What cultural influences shaped Barragán\'s use of color?',
                            a: 'Mexican vernacular architecture (bold painted walls in villages), Moorish gardens from his travels in North Africa and Spain, and the intense light of the Mexican landscape that makes saturated color glow.',
                            options: ['Japanese wabi-sabi and Zen minimalism', 'Mexican vernacular, Moorish gardens, and intense Mexican light', 'Bauhaus color theory from his time studying in Germany', 'Pop Art and American commercial advertising'],
                            correct: 1
                        },
                        {
                            q: 'Name a building where Barragán\'s color use is most evident.',
                            a: 'Casa Gilardi (1976) features a hallway that opens into a pool room bisected by a hot pink wall and a yellow wall — color transforms the space from corridor to immersive experience.',
                            options: ['Farnsworth House in Illinois', 'Casa Gilardi in Mexico City', 'Villa Savoye in Poissy', 'The Barcelona Pavilion'],
                            correct: 1
                        }
                    ]
                },
                {
                    name: 'Climate-Responsive Design', score: 0, priority: 'fresh',
                    questions: [
                        {
                            q: 'What are the three primary passive cooling strategies in Latin American architecture?',
                            a: 'Stack ventilation (height differences create airflow), thermal mass (thick walls absorb daytime heat, release at night), and shading (deep recesses, brise-soleil, courtyards block direct sun).',
                            options: ['Refrigerant circulation, double-pane glass, spray foam', 'Stack ventilation, thermal mass, and shading', 'Underground construction, reflective roofing, electric fans', 'Minimal windows, sealed envelopes, radiant floor cooling'],
                            correct: 1
                        },
                        {
                            q: 'What is a brise-soleil and who popularized its use?',
                            a: 'A brise-soleil is an exterior sun-shading device — horizontal or vertical fins that block direct sunlight while allowing ventilation. Le Corbusier popularized it, and it became essential in tropical modernism across Latin America.',
                            options: ['An interior curtain system; popularized by Frank Lloyd Wright', 'An exterior sun-shading device of fins; popularized by Le Corbusier', 'A type of reflective glass; developed by Mies van der Rohe', 'A rooftop garden system; invented by Geoffrey Bawa'],
                            correct: 1
                        },
                        {
                            q: 'How does thermal mass work as a passive cooling strategy?',
                            a: 'Thick masonry or concrete walls absorb heat during the day (keeping interiors cool) and radiate it at night when temperatures drop. This creates a natural thermal flywheel that dampens temperature swings.',
                            options: ['Thin walls rapidly transfer heat to cool the building faster', 'Thick walls absorb daytime heat and release it at night, dampening temperature swings', 'Walls are filled with water that evaporates for cooling', 'Metal surfaces reflect all solar radiation away from the building'],
                            correct: 1
                        }
                    ]
                }
            ]
        };
        
        function setRewindMode(mode, btn) {
            rewindState.mode = mode;
            document.querySelectorAll('.rewind-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            rewindState.flipped = false;
            rewindState.answered = false;
            loadQuestion();
        }
        
        function selectConcept(index) {
            rewindState.activeConcept = index;
            rewindState.questionIndex = 0;
            rewindState.flipped = false;
            rewindState.answered = false;
            updateConceptList();
            loadQuestion();
        }
        
        function updateConceptList() {
            const items = document.querySelectorAll('.rewind-concept-item');
            items.forEach((item, i) => {
                item.classList.toggle('active', i === rewindState.activeConcept);
            });
        }
        
        function loadQuestion() {
            const concept = rewindState.concepts[rewindState.activeConcept];
            const q = concept.questions[rewindState.questionIndex];
            const flashcardEl = document.getElementById('flashcard');
            const total = concept.questions.length;
            const current = rewindState.questionIndex + 1;
            
            // Update counter
            document.getElementById('rewind-card-counter').textContent = 'Question ' + current + ' of ' + total;
            document.getElementById('rewind-progress-text').textContent = 'Q' + current + ' of ' + total;
            document.getElementById('rewind-progress-fill').style.width = ((current / total) * 100) + '%';
            
            // Load card
            document.getElementById('flashcard-concept').textContent = concept.name;
            document.getElementById('flashcard-content').textContent = q.q;
            document.getElementById('flashcard-label').textContent = 'QUESTION';
            document.getElementById('flashcard-hint').textContent = rewindState.mode === 'options' ? 'Choose the correct answer' : 'Tap to reveal answer';
            document.getElementById('flashcard-hint').style.display = '';
            document.getElementById('flashcard-hint').style.color = '';
            flashcardEl.classList.remove('flipped', 'shake', 'correct-flash');
            document.getElementById('rewind-actions').classList.add('hidden');
            document.getElementById('see-answer-link').classList.add('hidden');
            rewindState.flipped = false;
            rewindState.answered = false;
            
            // Load options
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach((btn, i) => {
                btn.querySelector('.option-text').textContent = q.options[i];
                btn.classList.remove('correct', 'wrong', 'disabled');
            });
            
            // Show/hide based on mode
            if (rewindState.mode === 'options') {
                document.getElementById('flashcard-options').classList.remove('hidden');
            } else {
                document.getElementById('flashcard-options').classList.add('hidden');
            }
        }
        
        function flipCard() {
            if (rewindState.mode === 'options' && !rewindState.answered) return;
            if (rewindState.flipped) return;
            
            rewindState.flipped = true;
            const concept = rewindState.concepts[rewindState.activeConcept];
            const q = concept.questions[rewindState.questionIndex];
            document.getElementById('flashcard-label').textContent = 'ANSWER';
            document.getElementById('flashcard-content').textContent = q.a;
            document.getElementById('flashcard-hint').style.display = 'none';
            document.getElementById('flashcard').classList.add('flipped');
            document.getElementById('see-answer-link').classList.add('hidden');
            
            if (rewindState.mode === 'free') {
                document.getElementById('rewind-actions').classList.remove('hidden');
            }
        }
        
        function pickOption(index) {
            if (rewindState.answered) return;
            rewindState.answered = true;
            
            const concept = rewindState.concepts[rewindState.activeConcept];
            const q = concept.questions[rewindState.questionIndex];
            const flashcardEl = document.getElementById('flashcard');
            const optionBtns = document.querySelectorAll('.option-btn');
            const isCorrect = index === q.correct;
            
            optionBtns.forEach(btn => btn.classList.add('disabled'));
            optionBtns[q.correct].classList.add('correct');
            
            if (isCorrect) {
                flashcardEl.classList.add('correct-flash');
                document.getElementById('flashcard-hint').textContent = '✓ Correct';
                document.getElementById('flashcard-hint').style.color = '#28c840';
                document.getElementById('see-answer-link').classList.remove('hidden');
                setTimeout(() => nextQuestion(), 2000);
            } else {
                optionBtns[index].classList.add('wrong');
                flashcardEl.classList.add('shake');
                document.getElementById('flashcard-hint').textContent = '✗ Incorrect';
                document.getElementById('flashcard-hint').style.color = '#ff5f57';
                document.getElementById('see-answer-link').classList.remove('hidden');
                setTimeout(() => nextQuestion(), 3500);
            }
        }
        
        function showFullAnswer() {
            rewindState.flipped = true;
            const concept = rewindState.concepts[rewindState.activeConcept];
            const q = concept.questions[rewindState.questionIndex];
            document.getElementById('flashcard-label').textContent = 'ANSWER';
            document.getElementById('flashcard-content').textContent = q.a;
            document.getElementById('flashcard-hint').style.display = 'none';
            document.getElementById('flashcard').classList.add('flipped');
            document.getElementById('see-answer-link').classList.add('hidden');
        }
        
        function nextQuestion() {
            const concept = rewindState.concepts[rewindState.activeConcept];
            const next = rewindState.questionIndex + 1;
            
            if (next < concept.questions.length) {
                rewindState.questionIndex = next;
                loadQuestion();
            } else {
                // Concept complete — mark it
                const items = document.querySelectorAll('.rewind-concept-item');
                items[rewindState.activeConcept].classList.add('completed');
                
                // Try next concept
                const nextConcept = rewindState.activeConcept + 1;
                if (nextConcept < rewindState.concepts.length) {
                    selectConcept(nextConcept);
                } else {
                    showSessionComplete();
                }
            }
        }
        
        function showSessionComplete() {
            document.getElementById('flashcard-label').textContent = 'SESSION COMPLETE';
            document.getElementById('flashcard-concept').textContent = '';
            document.getElementById('flashcard-content').textContent = 'You\'ve reviewed all concepts. Great work.';
            document.getElementById('flashcard-hint').textContent = '';
            document.getElementById('flashcard-hint').style.color = '';
            document.getElementById('flashcard').classList.remove('flipped', 'shake', 'correct-flash');
            document.getElementById('rewind-actions').classList.add('hidden');
            document.getElementById('flashcard-options').classList.add('hidden');
            document.getElementById('see-answer-link').classList.add('hidden');
            document.getElementById('rewind-card-counter').textContent = 'All done!';
        }
        
        function rateCard(rating) {
            nextQuestion();
        }
        
        function updateRewindProgress() {
            // handled inline in loadQuestion now
        }
        
        function deepDiveConcept(conceptName) {
            openDeepDive(conceptName);
        }
        
        // ============ DEEP DIVE SYSTEM ============
        const deepDiveState = {
            conceptName: '',
            score: 52,
            startScore: 52,
            pendingScoreChange: 0,
            messageHistory: [],
            conversationPhase: 0, // 0=opening, 1=probing, 2=challenging, 3=confirming
            honesty: 0, // tracks honest admissions
            bullshit: 0, // tracks vague/evasive responses
            demonstrated: 0, // tracks demonstrated understanding
            isProcessing: false,
            concepts: {
                'Brutalist Movement Origins': {
                    score: 52,
                    professorNote: "Brutalism wasn't about being brutal — it was about honesty. Raw concrete, exposed structure, no pretense. It came from a post-war world that couldn't afford decoration and didn't want it anyway.",
                    related: ['Post-War Reconstruction', 'Béton Brut', 'Social Housing Movement'],
                    conversation: [
                        { phase: 'opening', tag: 'probe', text: "Okay so before I explain anything — tell me what you already know about how Brutalism started. Like what conditions do you think led to it?" },
                        { phase: 'probe', tag: 'probe', text: "You mentioned [X]. Why do you think that's significant? What does that actually mean for how buildings got designed?" },
                        { phase: 'challenge', tag: 'challenge', text: "You said concrete was cheap — but steel was also cheap and available. What made concrete specifically the material of choice for Brutalism?" },
                        { phase: 'challenge', tag: 'challenge', text: "That's partially right, but there's something deeper here. The Smithsons didn't just want cheap housing — they had a whole philosophy about it. What were they actually trying to say?" },
                        { phase: 'connect', tag: 'connect', text: "Nice. Now how does this connect to what was happening politically? Post-war Europe wasn't just broke — there was an ideological shift. What was it?" },
                        { phase: 'confirm', tag: 'confirm', text: "Okay you actually get this. You connected the material conditions to the philosophy and can think about it critically. That's real knowledge. I've updated your Latency Score." }
                    ]
                },
                'Barragán Color Theory': {
                    score: 67,
                    professorNote: "Barragán didn't paint walls — he built with color. The pink isn't decoration. It IS the architecture. It defines space, creates emotion, directs movement. Color as structure.",
                    related: ['Mexican Vernacular', 'Emotional Space', 'Light and Shadow'],
                    conversation: [
                        { phase: 'opening', tag: 'probe', text: "So tell me what you understand about how Barragán used color. Not what colors he used — but how he actually used them. What was his approach?" },
                    ]
                },
                'Mexican Modernism': {
                    score: 45,
                    professorNote: "Mexican Modernism refused to be International Style with a sombrero. Barragán, O'Gorman, Candela — they took modernist principles and made them Mexican. Identity wasn't optional.",
                    related: ['International Style', 'Pre-Columbian Heritage', 'Muralism'],
                    conversation: [
                        { phase: 'opening', tag: 'probe', text: "Mexican Modernism came up as something distinct from the International Style. What do you think were the key differences? Like what made it specifically Mexican?" },
                    ]
                },
                'Tropical Architecture': {
                    score: 58,
                    professorNote: "The International Style said 'one solution for everywhere.' Tropical Architecture said 'that's insane.' You can't seal a box in the tropics and pump AC forever. Work WITH the climate.",
                    related: ['Climate Response', 'Vernacular Techniques', 'Geoffrey Bawa'],
                    conversation: [
                        { phase: 'opening', tag: 'probe', text: "What's your take on why Tropical Architecture developed as a counter to modernist universal design? Like what problem was it trying to solve?" },
                    ]
                }
            }
        };
        
        function openDeepDive(conceptName) {
            const concept = deepDiveState.concepts[conceptName] || deepDiveState.concepts['Brutalist Movement Origins'];
            deepDiveState.conceptName = conceptName;
            deepDiveState.score = concept.score;
            deepDiveState.startScore = concept.score;
            deepDiveState.pendingScoreChange = 0;
            deepDiveState.messageHistory = [];
            deepDiveState.conversationPhase = 0;
            deepDiveState.honesty = 0;
            deepDiveState.bullshit = 0;
            deepDiveState.demonstrated = 0;
            
            // Update UI
            document.getElementById('deepdive-concept-name').textContent = conceptName;
            document.getElementById('deepdive-professor-note').textContent = concept.professorNote;
            updateDeepDiveScore(concept.score, false);
            
            // Update related concepts
            const relatedContainer = document.querySelector('.deepdive-related');
            relatedContainer.innerHTML = concept.related.map(r => 
                `<div class="deepdive-related-item" onclick="switchDeepDiveConcept('${r}')">
                    <div class="deepdive-related-dot"></div>
                    ${r}
                </div>`
            ).join('');
            
            // Clear and start conversation
            document.getElementById('deepdive-conversation').innerHTML = '';
            document.getElementById('deepdive-view').classList.add('visible');
            document.getElementById('course-detail-view').classList.remove('visible');
            
            // Send opening message after brief delay
            setTimeout(() => {
                addDeepDiveMessage('ai', 'probe', concept.conversation[0].text);
            }, 600);
        }
        
        function closeDeepDive() {
            document.getElementById('deepdive-view').classList.remove('visible');
            document.getElementById('course-detail-view').classList.add('visible');
        }
        
        function switchDeepDiveConcept(conceptName) {
            closeDeepDive();
            setTimeout(() => openDeepDive(conceptName), 300);
        }
        
        function updateDeepDiveScore(newScore, animate = true) {
            const oldScore = deepDiveState.score;
            deepDiveState.score = Math.max(0, Math.min(100, newScore));
            
            const scoreEl = document.getElementById('deepdive-score');
            const valueEl = document.getElementById('deepdive-score-value');
            const ringEl = document.getElementById('deepdive-score-ring');
            
            // Animate value
            if (animate) {
                const diff = deepDiveState.score - oldScore;
                const isRising = diff > 0;
                
                // Pulse effect
                scoreEl.classList.remove('pulse-up', 'pulse-down');
                void scoreEl.offsetWidth; // Force reflow
                scoreEl.classList.add(isRising ? 'pulse-up' : 'pulse-down');
                
                // Ring color
                ringEl.classList.remove('rising', 'falling');
                ringEl.classList.add(isRising ? 'rising' : 'falling');
                setTimeout(() => ringEl.classList.remove('rising', 'falling'), 600);
            }
            
            // Update value
            valueEl.textContent = deepDiveState.score;
            
            // Update ring (circumference = 2 * PI * 15.5 ≈ 97.4)
            const circumference = 97.4;
            const offset = circumference - (deepDiveState.score / 100) * circumference;
            ringEl.style.strokeDashoffset = offset;
        }
        
        function addDeepDiveMessage(sender, tag, text, scoreChange = null) {
            const container = document.getElementById('deepdive-conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `deepdive-message ${sender}`;
            
            // No tags, no inline score changes - just the conversation
            let html = `<div class="deepdive-message-bubble">${text}</div>`;
            
            messageDiv.innerHTML = html;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            deepDiveState.messageHistory.push({ sender, tag, text, scoreChange });
        }
        
        function showTypingIndicator() {
            const container = document.getElementById('deepdive-conversation');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'deepdive-message ai';
            typingDiv.id = 'deepdive-typing';
            typingDiv.innerHTML = `
                <div class="deepdive-typing">
                    <div class="deepdive-typing-dot"></div>
                    <div class="deepdive-typing-dot"></div>
                    <div class="deepdive-typing-dot"></div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typing = document.getElementById('deepdive-typing');
            if (typing) typing.remove();
        }
        
        function analyzeUserResponse(text) {
            const lower = text.toLowerCase();
            const wordCount = text.split(/\s+/).length;
            
            // Detect honesty signals
            const honestyPhrases = [
                "i don't know", "i'm not sure", "i think", "maybe", "i forgot",
                "can you explain", "what do you mean", "i'm confused", "help me understand",
                "honestly", "to be honest", "i'm struggling", "this is hard"
            ];
            const isHonest = honestyPhrases.some(p => lower.includes(p));
            
            // Detect bullshit signals
            const bullshitSignals = [
                wordCount < 8 && !lower.includes('?'), // Too short, not a question
                /basically|essentially|kind of|sort of|you know/i.test(lower) && wordCount < 15, // Filler words, short response
                lower === text.toLowerCase().replace(/[^a-z\s]/g, '') && wordCount < 5, // No substance
            ];
            const isBullshit = bullshitSignals.filter(Boolean).length >= 2;
            
            // Detect demonstrated understanding
            const demonstrationSignals = [
                wordCount > 20, // Substantive length
                /because|therefore|since|which means|led to|resulted in/i.test(lower), // Causal reasoning
                /for example|such as|like when|specifically/i.test(lower), // Concrete examples
                /connects to|relates to|similar to|different from/i.test(lower), // Making connections
            ];
            const isDemonstrated = demonstrationSignals.filter(Boolean).length >= 2;
            
            return { isHonest, isBullshit, isDemonstrated, wordCount };
        }
        
        function sendDeepDiveMessage() {
            const input = document.getElementById('deepdive-input');
            const text = input.value.trim();
            if (!text || deepDiveState.isProcessing) return;
            
            deepDiveState.isProcessing = true;
            input.value = '';
            input.style.height = 'auto';
            
            // Add user message
            addDeepDiveMessage('user', null, text);
            
            // Analyze response
            const analysis = analyzeUserResponse(text);
            
            // Show typing
            setTimeout(() => {
                showTypingIndicator();
                
                // Generate AI response based on analysis
                setTimeout(() => {
                    hideTypingIndicator();
                    respondToUser(text, analysis);
                    deepDiveState.isProcessing = false;
                }, 1500 + Math.random() * 1000);
            }, 400);
        }
        
        function respondToUser(userText, analysis) {
            let response = '';
            let tag = 'probe';
            let scoreChange = 0;
            
            if (analysis.isHonest) {
                // User admitted uncertainty — reward honesty, guide them
                deepDiveState.honesty++;
                scoreChange = -3; // Small cost for not knowing (tracked internally)
                deepDiveState.pendingScoreChange += scoreChange;
                
                const honestyResponses = [
                    "Okay real talk, I appreciate you being honest about that. Let's figure this out together...",
                    "No stress — that's literally why we're here. Let me walk you through it...",
                    "Hey, saying you don't know is actually huge. Most people just fake it. Let's break this down...",
                    "Love that you're being real with me. Okay so here's the thing..."
                ];
                response = honestyResponses[Math.floor(Math.random() * honestyResponses.length)];
                response += " So post-war Europe was in a wild spot — millions of people needed housing and there was literally no money. Concrete was cheap, fast, didn't need skilled workers. But here's what made it Brutalism: they didn't try to hide the concrete or make it pretty. They made the rawness the whole point. So here's my question — why would architects actually WANT their buildings to look unfinished?";
                tag = 'probe';
                
                addDeepDiveMessage('ai', tag, response, scoreChange);
                
            } else if (analysis.isBullshit) {
                // User is being vague/evasive — call it out gently but honestly
                deepDiveState.bullshit++;
                scoreChange = -5; // Reduced from -8
                deepDiveState.pendingScoreChange += scoreChange;
                
                const calloutResponses = [
                    "Okay I feel like there's more here though — can you be more specific? What exactly do you mean by that?",
                    "I hear you, but I'm not quite getting the full picture yet. What's the actual reasoning behind that?",
                    "Hmm, I want to make sure I'm understanding you right. Can you unpack that a bit more?",
                    "That's a start! But I think you might know more than you're letting on. What specifically are you thinking?"
                ];
                response = calloutResponses[Math.floor(Math.random() * calloutResponses.length)];
                tag = 'nudge';
                
                addDeepDiveMessage('ai', tag, response, scoreChange);
                
            } else if (analysis.isDemonstrated) {
                // User showed real understanding — reward and advance
                deepDiveState.demonstrated++;
                scoreChange = Math.floor(6 + Math.random() * 6); // +6 to +12
                deepDiveState.pendingScoreChange += scoreChange;
                
                if (deepDiveState.demonstrated >= 3) {
                    // Confirm understanding, show score reveal
                    response = "Okay you actually get this. You connected the material conditions to the philosophy and showed you can think critically about it. That's real understanding — not just memorizing facts.";
                    tag = 'confirm';
                    addDeepDiveMessage('ai', tag, response, scoreChange);
                    
                    // Trigger end-of-session score reveal
                    setTimeout(() => {
                        showScoreReveal();
                    }, 1500);
                    return;
                    
                } else if (deepDiveState.demonstrated === 2) {
                    // Connect to broader context
                    response = "Nice, you're making real connections now. Let me push you a bit further though: how does this whole 'honest materials' philosophy connect to what was happening politically in post-war Europe? There's a bigger ideological thread here.";
                    tag = 'connect';
                } else {
                    // Challenge further
                    const challenges = [
                        "Solid. Okay but here's where it gets interesting — if Brutalism was supposedly about honesty, why did so many people end up hating it? What went wrong?",
                        "Right, that tracks. Now let's apply it: if you were designing social housing today with those same principles, what would you do differently?",
                        "Good thinking. But here's a puzzle: Le Corbusier's Unité d'Habitation and the Smithsons' Robin Hood Gardens both used raw concrete — yet one is celebrated and one got demolished. Why?"
                    ];
                    response = challenges[Math.floor(Math.random() * challenges.length)];
                    tag = 'challenge';
                }
                
                addDeepDiveMessage('ai', tag, response, scoreChange);
                
            } else {
                // Neutral response — probe further
                deepDiveState.conversationPhase++;
                const probes = [
                    "Okay I'm with you so far. But what does that actually look like in practice? Give me a specific example.",
                    "You're in the right zone. I want to hear the WHY though — what's the reasoning behind that?",
                    "That's a good start. Now help me connect it — how does this relate to what your professor said about honesty in materials?",
                    "Keep going, you're circling around something important. What's the core principle you're getting at?"
                ];
                response = probes[Math.floor(Math.random() * probes.length)];
                tag = 'probe';
                
                addDeepDiveMessage('ai', tag, response, null);
            }
        }
        
        function showScoreReveal() {
            const startScore = deepDiveState.startScore;
            
            // If no pending change (demo mode), simulate a positive change
            if (deepDiveState.pendingScoreChange === 0) {
                deepDiveState.pendingScoreChange = Math.floor(8 + Math.random() * 12); // +8 to +20 for demo
            }
            
            const finalScore = Math.max(0, Math.min(100, startScore + deepDiveState.pendingScoreChange));
            const percentChange = ((finalScore - startScore) / startScore * 100).toFixed(0);
            const isPositive = finalScore >= startScore;
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'score-reveal-overlay';
            overlay.innerHTML = `
                <div class="score-reveal-content">
                    <div class="score-reveal-label">Your Latency Score</div>
                    <div class="score-reveal-ring">
                        <svg class="score-reveal-svg" viewBox="0 0 120 120">
                            <circle class="score-reveal-bg" cx="60" cy="60" r="52"/>
                            <circle class="score-reveal-fill" cx="60" cy="60" r="52" 
                                stroke-dasharray="326.7" stroke-dashoffset="326.7"/>
                        </svg>
                        <div class="score-reveal-value">0</div>
                    </div>
                    <div class="score-reveal-change ${isPositive ? 'positive' : 'negative'}">
                        ${isPositive ? '↑' : '↓'} ${isPositive ? '+' : ''}${percentChange}%
                    </div>
                    <div class="score-reveal-note">${isPositive ? 'Nice work on this concept' : 'Keep working on this one'}</div>
                    <button class="score-reveal-btn" onclick="closeScoreReveal()">Continue</button>
                </div>
            `;
            document.body.appendChild(overlay);
            
            // Animate after brief delay
            setTimeout(() => {
                overlay.classList.add('visible');
                
                // Animate score counting up
                const valueEl = overlay.querySelector('.score-reveal-value');
                const fillEl = overlay.querySelector('.score-reveal-fill');
                const circumference = 326.7;
                
                let current = 0;
                const duration = 2000;
                const startTime = Date.now();
                
                function animateScore() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing
                    const eased = 1 - Math.pow(1 - progress, 3);
                    
                    current = Math.floor(eased * finalScore);
                    valueEl.textContent = current;
                    
                    // Update ring
                    const offset = circumference - (current / 100) * circumference;
                    fillEl.style.strokeDashoffset = offset;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateScore);
                    } else {
                        // Final value
                        valueEl.textContent = finalScore;
                        
                        // Update actual score
                        deepDiveState.score = finalScore;
                        updateDeepDiveScore(finalScore, false);
                    }
                }
                
                setTimeout(animateScore, 400);
            }, 100);
        }
        
        function closeScoreReveal() {
            const overlay = document.querySelector('.score-reveal-overlay');
            if (overlay) {
                overlay.classList.remove('visible');
                setTimeout(() => {
                    overlay.remove();
                    // Go back to course detail view
                    closeDeepDive();
                }, 400);
            }
        }
        
        function handleDeepDiveKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendDeepDiveMessage();
            }
        }
        
        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }
        
        function toggleDeepDiveVoice() {
            const btn = document.getElementById('deepdive-voice');
            btn.classList.toggle('recording');
            
            if (btn.classList.contains('recording')) {
                // Would start voice recording here
                setTimeout(() => {
                    btn.classList.remove('recording');
                    // Simulate voice input
                    document.getElementById('deepdive-input').value = "I think Brutalism came from the need for cheap housing after World War 2, and they used concrete because it was affordable and fast to build with.";
                    autoResizeTextarea(document.getElementById('deepdive-input'));
                }, 3000);
            }
        }
        
        function toggleTextInput() {
            alert('Text input mode coming soon!');
        }
        
        function toggleCameraMode() {
            const canvas = document.getElementById('studio-canvas');
            document.querySelectorAll('.edit-tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('camera-tool').classList.add('active');
            boxMode = false;
            sketchMode = false;
            
            // Remove existing indicators
            const existing = document.getElementById('sketch-mode-indicator');
            if (existing) existing.remove();
            
            // Show camera mode indicator
            const indicator = document.createElement('div');
            indicator.id = 'sketch-mode-indicator';
            indicator.style.cssText = 'position:absolute;top:60px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border);padding:8px 16px;border-radius:100px;font-size:12px;font-weight:500;z-index:25;display:flex;align-items:center;gap:8px;';
            indicator.innerHTML = '<span style="width:8px;height:8px;background:#3b82f6;border-radius:50%;"></span> Camera Mode — Show your sketch, AI sees live';
            canvas.appendChild(indicator);
        }
        
        function triggerUpload() {
            document.getElementById('upload-input').click();
        }
        
        function handleUpload(event) {
            const file = event.target.files[0];
            if (file) {
                alert('Uploaded: ' + file.name + '\nAI will analyze this image...');
            }
        }
        
        // Studio functions
        function toggleStudioSidebar() {
            document.getElementById('studio-sidebar').classList.toggle('collapsed');
        }
        
        function initWaveform() {
            const container = document.getElementById('waveform-bar');
            if (!container) return;
            const w = window.innerWidth;
            const lineCount = Math.floor(w / 5);
            container.innerHTML = '';
            waveformLines = [];
            for (let i = 0; i < lineCount; i++) {
                const line = document.createElement('div');
                line.className = 'waveform-line';
                line.style.height = '4px';
                container.appendChild(line);
                waveformLines.push(line);
            }
            breatheWaveform();
        }
        
        function breatheWaveform() {
            if (isRecording) return;
            const time = Date.now() / 2000;
            waveformLines.forEach((line, i) => {
                const wave = Math.sin(time + i * 0.08) * 0.4 + 0.6;
                line.style.height = `${3 + wave * 6}px`;
            });
            requestAnimationFrame(breatheWaveform);
        }
        
        function animateWaveform() {
            if (!isRecording) return;
            const time = Date.now() / 50;
            waveformLines.forEach((line, i) => {
                // Create more dynamic, speech-like waveform
                const centerIndex = waveformLines.length / 2;
                const distFromCenter = Math.abs(i - centerIndex) / centerIndex;
                const baseAmplitude = 1 - distFromCenter * 0.5; // Higher in center
                
                // Multiple frequencies for more organic movement
                const wave1 = Math.sin(time + i * 0.5) * 0.4;
                const wave2 = Math.sin(time * 1.3 + i * 0.3) * 0.3;
                const wave3 = Math.sin(time * 2.1 + i * 0.7) * 0.2;
                const noise = (Math.random() - 0.5) * 0.3; // Add randomness
                
                const combined = (wave1 + wave2 + wave3 + noise) * baseAmplitude;
                const height = 4 + (combined + 1) * 16;
                line.style.height = `${Math.max(4, height)}px`;
            });
            requestAnimationFrame(animateWaveform);
        }
        
        function toggleRecording() {
            isRecording = !isRecording;
            const waveform = document.getElementById('waveform');
            const indicator = document.getElementById('recording-indicator');
            const dialogueText = document.getElementById('dialogue-text');
            const empty = document.getElementById('empty-state');
            
            // Pulse animation on click
            waveform.classList.add('pulse');
            setTimeout(() => waveform.classList.remove('pulse'), 300);
            
            if (isRecording) {
                waveform.classList.add('active');
                indicator.classList.add('visible');
                if (empty) empty.style.opacity = '0.3';
                if (dialogueText) {
                    dialogueText.textContent = '';
                    dialogueText.classList.remove('empty');
                    // Simulate typing
                    simulateTyping(dialogueText);
                }
                animateWaveform();
            } else {
                waveform.classList.remove('active');
                indicator.classList.remove('visible');
                breatheWaveform();
            }
        }
        
        function simulateTyping(element) {
            const phrases = [
                "I want a museum with an open courtyard in the center...",
                "Make the entrance face south with floor-to-ceiling glass...",
                "Add a mezzanine level overlooking the main gallery...",
                "Keep it minimal, concrete and wood only..."
            ];
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];
            let i = 0;
            const typing = setInterval(() => {
                if (!isRecording || i >= phrase.length) {
                    clearInterval(typing);
                    return;
                }
                element.textContent += phrase[i];
                i++;
            }, 50);
        }
        
        function toggleBoxMode() {
            boxMode = !boxMode;
            sketchMode = false;
            document.getElementById('box-tool').classList.toggle('active', boxMode);
            document.getElementById('sketch-tool').classList.remove('active');
            const canvas = document.getElementById('studio-canvas');
            canvas.style.cursor = boxMode ? 'crosshair' : 'default';
            
            if (boxMode) {
                canvas.addEventListener('mousedown', startBox);
            } else {
                canvas.removeEventListener('mousedown', startBox);
            }
        }
        
        function toggleSketchMode() {
            sketchMode = !sketchMode;
            boxMode = false;
            document.getElementById('sketch-tool').classList.toggle('active', sketchMode);
            document.getElementById('box-tool').classList.remove('active');
            const canvas = document.getElementById('studio-canvas');
            
            if (sketchMode) {
                canvas.style.cursor = 'crosshair';
                canvas.removeEventListener('mousedown', startBox);
                // Show sketch mode indicator
                const indicator = document.createElement('div');
                indicator.id = 'sketch-mode-indicator';
                indicator.style.cssText = 'position:absolute;top:60px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border);padding:8px 16px;border-radius:100px;font-size:12px;font-weight:500;z-index:25;display:flex;align-items:center;gap:8px;';
                indicator.innerHTML = '<span style="width:8px;height:8px;background:#22c55e;border-radius:50%;"></span> Sketch Mode — Draw on canvas, AI sees live';
                canvas.appendChild(indicator);
            } else {
                canvas.style.cursor = 'default';
                const indicator = document.getElementById('sketch-mode-indicator');
                if (indicator) indicator.remove();
            }
        }
        
        let boxStart = null;
        let currentBox = null;
        
        function startBox(e) {
            if (!boxMode) return;
            const rect = e.currentTarget.getBoundingClientRect();
            boxStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            
            currentBox = document.createElement('div');
            currentBox.className = 'edit-box';
            const color = boxColors[boxColorIndex % boxColors.length];
            boxColorIndex++;
            currentBox.style.borderColor = color;
            currentBox.style.backgroundColor = color + '20';
            currentBox.style.left = boxStart.x + 'px';
            currentBox.style.top = boxStart.y + 'px';
            currentBox.innerHTML = '<div class="edit-box-handle">×</div>';
            
            document.getElementById('studio-canvas').appendChild(currentBox);
            
            document.addEventListener('mousemove', drawBox);
            document.addEventListener('mouseup', endBox);
        }
        
        function drawBox(e) {
            if (!currentBox || !boxStart) return;
            const canvas = document.getElementById('studio-canvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const w = x - boxStart.x;
            const h = y - boxStart.y;
            
            if (w < 0) {
                currentBox.style.left = x + 'px';
                currentBox.style.width = -w + 'px';
            } else {
                currentBox.style.width = w + 'px';
            }
            
            if (h < 0) {
                currentBox.style.top = y + 'px';
                currentBox.style.height = -h + 'px';
            } else {
                currentBox.style.height = h + 'px';
            }
        }
        
        function endBox() {
            document.removeEventListener('mousemove', drawBox);
            document.removeEventListener('mouseup', endBox);
            
            if (currentBox) {
                const handle = currentBox.querySelector('.edit-box-handle');
                handle.onclick = () => currentBox.remove();
            }
            
            currentBox = null;
            boxStart = null;
        }
        
        window.addEventListener('resize', resize);
        resize();
        initParticles();
        requestAnimationFrame(animate);
        
        // Start animation — skip typing intro, go straight to welcome → tools
        hideAll();
        setPhase('settle');
        
        // Show welcome screen after a brief pause
        setTimeout(() => {
            document.getElementById('welcome-screen').classList.add('visible');
            
            // Then transition to tools
            setTimeout(() => {
                document.getElementById('welcome-screen').classList.remove('visible');
                setTimeout(() => {
                    document.getElementById('tools-screen').classList.add('visible');
                    currentFrame = 6;
                }, 400);
            }, 1800);
        }, 600);
    </script>
</body>
</html>
